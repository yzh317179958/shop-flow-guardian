{% extends "base.html" %}

{% block title %}商品管理 - Fiido 测试工作台{% endblock %}

{% block extra_css %}
<style>
/* 分类标题样式 */
.category-header {
    font-size: 1.1rem;
    color: var(--color-black);
    padding: 12px 16px;
    background: var(--gray-100);
    border-radius: var(--radius-md);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.category-header i {
    color: var(--gray-600);
}
.category-header .badge {
    background: var(--gray-400) !important;
    font-weight: 500;
}

/* 商品卡片样式 */
.product-card {
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    transition: all var(--transition-normal);
    cursor: pointer;
}
.product-card:hover {
    border-color: var(--color-black);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}
.product-card .card-title {
    color: var(--color-black);
    font-weight: 600;
}
.product-card .product-info {
    color: var(--gray-600);
    font-size: 0.875rem;
}
.product-card .card-footer {
    background: transparent;
    border-top: 1px solid var(--gray-100);
    padding-top: 12px;
}

/* 进度对话框样式 */
.modal-header.bg-primary {
    background: var(--color-black) !important;
}
</style>
{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="page-header">
    <h2><i class="bi bi-box-seam"></i> 商品管理</h2>
    <p>发现、查看和管理测试商品</p>
</div>

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-end">
        <button class="btn btn-primary btn-lg" onclick="discoverProducts()">
            <i class="bi bi-search"></i> 发现商品
        </button>
    </div>
</div>

<!-- 筛选器 -->
<div class="filter-section">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">优先级</label>
            <select class="form-select" id="filter-priority" onchange="filterProducts()">
                <option value="">全部</option>
                <option value="P0">整车</option>
                <option value="P1">重要配件</option>
                <option value="P2">普通配件</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">分类</label>
            <select class="form-select" id="filter-category" onchange="filterProducts()">
                <option value="">全部</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">搜索</label>
            <input type="text" class="form-control" id="search-input" placeholder="搜索商品名称或ID..." oninput="filterProducts()">
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise"></i> 重置
            </button>
        </div>
    </div>
</div>

<!-- 商品统计 -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">商品总数</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">整车</div>
                <div class="stat-value" id="stat-p0" style="color: var(--color-danger);">0</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">重要配件</div>
                <div class="stat-value" id="stat-p1" style="color: var(--color-warning);">0</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">普通配件</div>
                <div class="stat-value" id="stat-p2" style="color: var(--color-info);">0</div>
            </div>
        </div>
    </div>
</div>

<!-- 商品列表 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>商品列表</span>
        <span class="badge bg-primary" id="product-count">0 个商品</span>
    </div>
    <div class="card-body" id="products-container">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    </div>
</div>

<!-- 商品详情Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">商品详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productModalBody">
                <!-- 内容将由JavaScript填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="testCurrentProduct()">
                    <i class="bi bi-play-circle"></i> 测试此商品
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allProducts = [];
let filteredProducts = [];
let currentProduct = null;

// 页面加载时获取商品列表
document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
});

// 加载商品列表
async function loadProducts() {
    try {
        const response = await fetch('/api/products/list');
        const data = await response.json();

        allProducts = data.products || [];
        filteredProducts = [...allProducts];

        if (allProducts.length === 0) {
            utils.showEmptyState('products-container', '暂无商品数据，请先点击"发现商品"按钮', 'box-seam');
            return;
        }

        // 更新统计
        updateStats();

        // 填充分类选择器
        populateCategoryFilter();

        // 显示商品
        displayProducts();

    } catch (error) {
        console.error('加载商品列表失败:', error);
        utils.showError('products-container', '加载商品列表失败: ' + error.message);
    }
}

// 更新统计数据
function updateStats() {
    const p0Count = allProducts.filter(p => p.priority === 'P0').length;
    const p1Count = allProducts.filter(p => p.priority === 'P1').length;
    const p2Count = allProducts.filter(p => p.priority === 'P2').length;

    document.getElementById('stat-total').textContent = allProducts.length;
    document.getElementById('stat-p0').textContent = p0Count;
    document.getElementById('stat-p1').textContent = p1Count;
    document.getElementById('stat-p2').textContent = p2Count;
}

// 填充分类筛选器
function populateCategoryFilter() {
    const categories = [...new Set(allProducts.map(p => p.category).filter(c => c))];
    const select = document.getElementById('filter-category');

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
    });
}

// 显示商品
function displayProducts() {
    const container = document.getElementById('products-container');
    document.getElementById('product-count').textContent = `${filteredProducts.length} 个商品`;

    if (filteredProducts.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>没有符合条件的商品</p></div>';
        return;
    }

    // 按分类分组
    const productsByCategory = {};
    filteredProducts.forEach(product => {
        const category = product.category || '未分类';
        if (!productsByCategory[category]) {
            productsByCategory[category] = [];
        }
        productsByCategory[category].push(product);
    });

    // 按分类名称排序
    const sortedCategories = Object.keys(productsByCategory).sort();

    // 生成HTML - 分类分组显示
    const html = sortedCategories.map(category => {
        const products = productsByCategory[category];

        return `
            <div class="category-section mb-4">
                <h5 class="category-header">
                    <i class="bi bi-folder"></i> ${escapeHtml(category)}
                    <span class="badge bg-secondary ms-2">${products.length}</span>
                </h5>
                <div class="row g-3">
                    ${products.map(product => `
                        <div class="col-md-6 col-lg-4 col-xl-3">
                            <div class="card product-card h-100" onclick="showProductDetail('${product.id}')">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0" style="font-size: 0.9rem; line-height: 1.3;">${escapeHtml(product.name)}</h6>
                                        <span class="product-priority ms-1 flex-shrink-0">
                                            ${utils.getPriorityBadge(product.priority)}
                                        </span>
                                    </div>
                                    <div class="product-info">
                                        <div class="mb-2">
                                            <i class="bi bi-tag" style="color: var(--gray-500);"></i> ${formatPriceRange(product)}
                                        </div>
                                        ${product.variants && product.variants.length > 0 ? `
                                            <p class="text-muted small mb-1">
                                                <i class="bi bi-palette"></i> ${product.variants.length} 个变体
                                            </p>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-top-0 pt-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="bi bi-link-45deg"></i>
                                            <a href="${product.url}" target="_blank" onclick="event.stopPropagation()" class="text-truncate d-inline-block" style="max-width: 100px;">
                                                查看官网
                                            </a>
                                        </small>
                                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); testProduct('${product.id}')">
                                            <i class="bi bi-play-circle"></i> 测试
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// 筛选商品
function filterProducts() {
    const priority = document.getElementById('filter-priority').value;
    const category = document.getElementById('filter-category').value;
    const search = document.getElementById('search-input').value.toLowerCase();

    filteredProducts = allProducts.filter(product => {
        if (priority && product.priority !== priority) return false;
        if (category && product.category !== category) return false;
        if (search && !product.name.toLowerCase().includes(search) && !product.id.toLowerCase().includes(search)) {
            return false;
        }
        return true;
    });

    displayProducts();
}

// 重置筛选器
function resetFilters() {
    document.getElementById('filter-priority').value = '';
    document.getElementById('filter-category').value = '';
    document.getElementById('search-input').value = '';
    filterProducts();
}

// 显示商品详情
function showProductDetail(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;

    currentProduct = product;

    document.getElementById('productModalTitle').textContent = product.name;

    const html = `
        <div class="mb-3">
            <label class="fw-bold">商品ID</label>
            <p>${escapeHtml(product.id)}</p>
        </div>
        <div class="mb-3">
            <label class="fw-bold">分类</label>
            <p>${escapeHtml(product.category || '未分类')}</p>
        </div>
        <div class="mb-3">
            <label class="fw-bold">优先级</label>
            <p>${utils.getPriorityBadge(product.priority)}</p>
        </div>
        <div class="mb-3">
            <label class="fw-bold">价格范围</label>
            <p>${formatPriceRange(product)}</p>
        </div>
        <div class="mb-3">
            <label class="fw-bold">商品链接</label>
            <p><a href="${product.url}" target="_blank">${product.url}</a></p>
        </div>
        ${product.variants && product.variants.length > 0 ? `
            <div class="mb-3">
                <label class="fw-bold">商品变体 (${product.variants.length})</label>
                <div class="table-responsive mt-2">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>颜色</th>
                                <th>尺寸</th>
                                <th>价格</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${product.variants.slice(0, 10).map(v => `
                                <tr>
                                    <td>${escapeHtml(v.color || '-')}</td>
                                    <td>${escapeHtml(v.size || '-')}</td>
                                    <td>${v.price ? '$' + v.price : '-'}</td>
                                </tr>
                            `).join('')}
                            ${product.variants.length > 10 ? `
                                <tr>
                                    <td colspan="3" class="text-muted">
                                        <small>还有 ${product.variants.length - 10} 个变体...</small>
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        ` : ''}
    `;

    document.getElementById('productModalBody').innerHTML = html;

    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

// 快速测试指定商品
function testProduct(productId) {
    // 直接跳转到测试页面
    window.location.href = `/tests?product_id=${productId}`;
}

// 测试当前商品
function testCurrentProduct() {
    if (!currentProduct) return;

    // 关闭详情模态框
    const detailModal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    if (detailModal) detailModal.hide();

    // 跳转到测试页面
    window.location.href = `/tests?product_id=${currentProduct.id}`;
}

// 发现商品
function discoverProducts() {
    if (!confirm('这将重新发现所有商品，可能需要几分钟时间。是否继续？')) {
        return;
    }

    // 显示进度对话框
    showProgressModal();

    fetch('/api/products/discover', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            utils.showToast('商品发现任务已启动...', 'info');

            // 开始轮询任务状态，显示实时进度
            pollTaskProgress(data.task_id);
        })
        .catch(error => {
            hideProgressModal();
            utils.showToast('启动任务失败: ' + error.message, 'error');
        });
}

// 显示进度对话框
function showProgressModal() {
    const modalHtml = `
        <div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-search"></i> 正在发现商品
                        </h5>
                    </div>
                    <div class="modal-body">
                        <!-- 进度信息 -->
                        <div class="mb-3">
                            <h6>当前进度</h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     id="discover-progress-bar"
                                     role="progressbar"
                                     style="width: 0%">
                                    <span id="discover-progress-text">0%</span>
                                </div>
                            </div>
                            <p class="text-muted mb-0" id="discover-status-message">
                                <i class="bi bi-hourglass-split"></i> 正在初始化...
                            </p>
                        </div>

                        <!-- 实时日志 -->
                        <div class="mb-3">
                            <h6>处理日志
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleLogs()" id="toggle-logs-btn">
                                    <i class="bi bi-chevron-down"></i> 展开
                                </button>
                            </h6>
                            <div id="discover-logs" class="log-output" style="max-height: 200px; overflow-y: auto; display: none;">
                                <p class="text-muted">等待日志输出...</p>
                            </div>
                        </div>

                        <!-- 统计信息（完成后显示） -->
                        <div id="discover-stats" style="display: none;">
                            <h6>发现统计</h6>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-2">
                                            <h4 class="mb-0" id="stats-collections">0</h4>
                                            <small class="text-muted">扫描分类数</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-2">
                                            <h4 class="mb-0 text-success" id="stats-total">0</h4>
                                            <small class="text-muted">商品总数</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-2">
                                            <h4 class="mb-0 text-primary" id="stats-new">0</h4>
                                            <small class="text-muted">新增商品</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body text-center p-2">
                                            <h4 class="mb-0 text-info" id="stats-duration">0s</h4>
                                            <small class="text-muted">执行耗时</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="close-progress-btn" disabled>
                            关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 移除旧modal（如果存在）
    const oldModal = document.getElementById('progressModal');
    if (oldModal) {
        oldModal.remove();
    }

    // 添加新modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // 显示modal
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
}

// 隐藏进度对话框
function hideProgressModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
    if (modal) {
        modal.hide();
    }
    // 移除modal元素
    setTimeout(() => {
        const modalEl = document.getElementById('progressModal');
        if (modalEl) {
            modalEl.remove();
        }
    }, 500);
}

// 切换日志显示
function toggleLogs() {
    const logsDiv = document.getElementById('discover-logs');
    const btn = document.getElementById('toggle-logs-btn');

    if (logsDiv.style.display === 'none') {
        logsDiv.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-chevron-up"></i> 收起';
    } else {
        logsDiv.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-chevron-down"></i> 展开';
    }
}

// 轮询任务进度
function pollTaskProgress(taskId) {
    const pollInterval = 1000; // 每秒轮询一次
    let lastLogCount = 0;

    const poll = async () => {
        try {
            const response = await fetch(`/api/tests/status/${taskId}`);
            const data = await response.json();

            // 更新进度条
            if (data.progress) {
                const { current, total, message } = data.progress;

                if (total > 0) {
                    const percentage = Math.round((current / total) * 100);
                    const progressBar = document.getElementById('discover-progress-bar');
                    const progressText = document.getElementById('discover-progress-text');

                    if (progressBar) {
                        progressBar.style.width = percentage + '%';
                        progressText.textContent = percentage + '%';
                    }
                }

                // 更新状态消息
                const statusMsg = document.getElementById('discover-status-message');
                if (statusMsg && message) {
                    statusMsg.innerHTML = `<i class="bi bi-hourglass-split"></i> ${message}`;
                }
            }

            // 更新日志
            if (data.logs && data.logs.length > lastLogCount) {
                const logsDiv = document.getElementById('discover-logs');
                if (logsDiv) {
                    const newLogs = data.logs.slice(lastLogCount);
                    const logsHtml = newLogs.map(log => {
                        // 高亮关键信息
                        if (log.includes('ERROR') || log.includes('Failed')) {
                            return `<div class="log-error">${escapeHtml(log)}</div>`;
                        } else if (log.includes('Found') || log.includes('Discovered')) {
                            return `<div class="log-success">${escapeHtml(log)}</div>`;
                        } else if (log.includes('WARNING')) {
                            return `<div class="log-warning">${escapeHtml(log)}</div>`;
                        }
                        return `<div>${escapeHtml(log)}</div>`;
                    }).join('');

                    if (lastLogCount === 0) {
                        logsDiv.innerHTML = logsHtml;
                    } else {
                        logsDiv.insertAdjacentHTML('beforeend', logsHtml);
                    }

                    // 自动滚动到底部
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                    lastLogCount = data.logs.length;
                }
            }

            // 更新统计信息
            if (data.stats) {
                const statsDiv = document.getElementById('discover-stats');
                if (statsDiv) {
                    statsDiv.style.display = 'block';

                    if (data.stats.collections) {
                        document.getElementById('stats-collections').textContent = data.stats.collections;
                    }
                    if (data.stats.total_products) {
                        document.getElementById('stats-total').textContent = data.stats.total_products;
                    }
                    if (data.stats.new_products) {
                        document.getElementById('stats-new').textContent = data.stats.new_products;
                    }
                    if (data.stats.duration) {
                        document.getElementById('stats-duration').textContent = data.stats.duration.toFixed(2) + 's';
                    }
                }
            }

            // 检查任务是否完成
            if (data.status === 'completed' || data.status === 'failed' || data.status === 'timeout' || data.status === 'error') {
                // 任务完成
                const progressBar = document.getElementById('discover-progress-bar');
                if (progressBar) {
                    progressBar.style.width = '100%';
                    document.getElementById('discover-progress-text').textContent = '100%';
                    progressBar.classList.remove('progress-bar-animated');
                }

                const statusMsg = document.getElementById('discover-status-message');
                if (data.status === 'completed') {
                    if (statusMsg) {
                        statusMsg.innerHTML = '<i class="bi bi-check-circle text-success"></i> 商品发现完成！';
                    }
                    utils.showToast('商品发现完成！', 'success');
                } else {
                    if (statusMsg) {
                        statusMsg.innerHTML = `<i class="bi bi-x-circle text-danger"></i> 任务失败: ${data.status}`;
                    }
                    utils.showToast('商品发现失败', 'error');
                }

                // 启用关闭按钮
                const closeBtn = document.getElementById('close-progress-btn');
                if (closeBtn) {
                    closeBtn.disabled = false;
                    closeBtn.onclick = () => {
                        hideProgressModal();
                        // 刷新商品列表
                        if (data.status === 'completed') {
                            setTimeout(() => location.reload(), 500);
                        }
                    };
                }

                return; // 停止轮询
            }

            // 继续轮询
            setTimeout(poll, pollInterval);

        } catch (error) {
            console.error('轮询任务进度失败:', error);
            const statusMsg = document.getElementById('discover-status-message');
            if (statusMsg) {
                statusMsg.innerHTML = '<i class="bi bi-x-circle text-danger"></i> 无法获取任务状态';
            }
        }
    };

    // 开始轮询
    poll();
}

// 工具函数
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPriceRange(product) {
    const priceMin = product.price_min || 0;
    const priceMax = product.price_max || 0;

    if (priceMin <= 0 && priceMax <= 0) {
        return '<span class="text-muted">价格待更新</span>';
    }

    // 格式化价格显示（添加千分位分隔符）
    const formatPrice = (price) => {
        return price.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    };

    if (priceMin === priceMax) {
        return `<span style="color: var(--color-black); font-weight: 600;">$${formatPrice(priceMin)}</span>`;
    }

    return `<span style="color: var(--color-black); font-weight: 600;">$${formatPrice(priceMin)}</span> - <span style="color: var(--color-black); font-weight: 600;">$${formatPrice(priceMax)}</span>`;
}
</script>
{% endblock %}
