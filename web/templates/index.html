{% extends "base.html" %}

{% block title %}首页 - Fiido 测试工作台{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="page-header">
    <h2><i class="bi bi-house-door"></i> 控制台</h2>
    <p>Fiido 官网购物流程自动化测试系统</p>
</div>

<!-- 统计卡片 -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">商品总数</div>
                <div class="stat-value" id="total-products">-</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">通过率</div>
                <div class="stat-value" id="pass-rate" style="color: var(--color-success);">-</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">失败数</div>
                <div class="stat-value" id="failed-count" style="color: var(--color-danger);">-</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body stat-card">
                <div class="stat-label">测试报告</div>
                <div class="stat-value" id="report-count">-</div>
            </div>
        </div>
    </div>
</div>

<!-- 主要功能区 -->
<div class="row g-4">
    <!-- 快速操作 -->
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-lightning-charge"></i> 快速操作
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="/tests" class="btn btn-primary btn-lg">
                        <i class="bi bi-play-circle"></i> 开始测试
                    </a>
                    <button class="btn btn-outline-primary btn-lg" onclick="discoverProducts()">
                        <i class="bi bi-search"></i> 发现商品
                    </button>
                    <a href="/reports" class="btn btn-light btn-lg">
                        <i class="bi bi-file-text"></i> 查看报告
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 最新测试结果 -->
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history"></i> 最近测试</span>
                <a href="/reports" class="btn btn-sm btn-light">查看全部</a>
            </div>
            <div class="card-body" id="recent-tests">
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务执行Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">执行中</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">执行中...</span>
                    </div>
                </div>
                <p class="text-center mb-3" id="task-message">正在执行任务...</p>
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData();
    loadRecentTests();
});

async function loadDashboardData() {
    try {
        // 获取商品数量
        const productsRes = await fetch('/api/products/list');
        const productsData = await productsRes.json();
        document.getElementById('total-products').textContent = productsData.total || 0;

        // 获取报告列表
        const reportsRes = await fetch('/api/reports/list');
        const reportsData = await reportsRes.json();
        document.getElementById('report-count').textContent = reportsData.total || 0;

        // 获取最新报告统计
        if (reportsData.reports && reportsData.reports.length > 0) {
            const latestReport = reportsData.reports[0];
            const summary = latestReport.summary || {};
            const total = summary.total || 0;
            const passed = summary.passed || 0;
            const failed = summary.failed || 0;

            const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;
            document.getElementById('pass-rate').textContent = passRate + '%';
            document.getElementById('failed-count').textContent = failed;
        } else {
            document.getElementById('pass-rate').textContent = '-';
            document.getElementById('failed-count').textContent = '-';
        }
    } catch (error) {
        console.error('加载数据失败:', error);
    }
}

async function loadRecentTests() {
    try {
        const response = await fetch('/api/reports/list');
        const data = await response.json();
        const reports = data.reports || [];

        if (reports.length === 0) {
            document.getElementById('recent-tests').innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>暂无测试记录</p>
                </div>
            `;
            return;
        }

        const html = reports.slice(0, 5).map(report => {
            const summary = report.summary || {};
            const total = summary.total || 0;
            const passed = summary.passed || 0;
            const failed = summary.failed || 0;
            const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;

            return `
                <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
                    <div>
                        <div class="fw-medium">${report.test_scope || '测试'}</div>
                        <small class="text-muted">${utils.formatDateTime(report.timestamp)}</small>
                    </div>
                    <div class="text-end">
                        <div>
                            <span class="badge bg-success">${passed}</span>
                            <span class="badge bg-danger">${failed}</span>
                        </div>
                        <small class="text-muted">${passRate}% 通过</small>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('recent-tests').innerHTML = html;
    } catch (error) {
        console.error('加载最近测试失败:', error);
        document.getElementById('recent-tests').innerHTML = `
            <div class="alert alert-danger">加载失败</div>
        `;
    }
}

function discoverProducts() {
    showTaskModal('正在发现商品...');

    fetch('/api/products/discover', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            utils.pollTaskStatus(data.task_id,
                (status) => {
                    if (status.progress && status.progress.message) {
                        document.getElementById('task-message').textContent = status.progress.message;
                    }
                },
                (result) => {
                    hideTaskModal();
                    if (result.status === 'completed') {
                        let message = '商品发现完成！';
                        if (result.stats) {
                            message += ` 共${result.stats.total_products || 0}个商品`;
                        }
                        utils.showToast(message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        utils.showToast('商品发现失败', 'error');
                    }
                }
            );
        })
        .catch(error => {
            hideTaskModal();
            utils.showToast('启动任务失败: ' + error.message, 'error');
        });
}

function showTaskModal(message) {
    document.getElementById('task-message').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('taskModal'));
    modal.show();
}

function hideTaskModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
    if (modal) modal.hide();
}
</script>
{% endblock %}
