{% extends "base.html" %}

{% block title %}æµ‹è¯•æ‰§è¡Œ - Fiido æµ‹è¯•å·¥ä½œå°{% endblock %}

{% block extra_css %}
<style>
/* èŒƒå›´é€‰æ‹©å¡ç‰‡æ ·å¼ */
.custom-option-card {
    padding: 0;
}
.custom-option-card .form-check-input {
    display: none;
}
.custom-option-card .scope-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid var(--gray-200);
    border-radius: 8px;
}
.custom-option-card .scope-card:hover {
    border-color: var(--color-black);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}
.custom-option-card .form-check-input:checked + .form-check-label .scope-card {
    border-color: var(--color-black);
    background-color: var(--gray-50);
}

/* åˆ†ç±»å¡ç‰‡æ ·å¼ */
.category-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid #dee2e6;
}
.category-card:hover {
    border-color: #198754;
    transform: translateY(-1px);
}
.category-card.selected {
    border-color: #198754;
    background-color: #d1e7dd;
}

/* å•†å“é€‰æ‹©é¡¹æ ·å¼ */
.product-check-item {
    padding: 8px 12px;
    border-radius: 6px;
    transition: background-color 0.15s;
}
.product-check-item:hover {
    background-color: var(--gray-100);
}
.product-check-item .form-check-input:checked ~ .form-check-label {
    color: var(--color-black);
    font-weight: 500;
}

/* å·²é€‰å•†å“æ ‡ç­¾ */
.selected-tag {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    margin: 2px;
    background-color: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-radius: 16px;
    font-size: 12px;
    color: var(--gray-700);
}
.selected-tag .remove-tag {
    margin-left: 4px;
    cursor: pointer;
    color: #dc3545;
}
.selected-tag .remove-tag:hover {
    color: #b02a37;
}

/* æœç´¢ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */
#single-product-dropdown {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
}
.product-dropdown-item {
    cursor: pointer;
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    background-color: #ffffff;
}
.product-dropdown-item:hover {
    background-color: #f0f7ff;
}
.product-dropdown-item:last-child {
    border-bottom: none;
}

/* æµ‹è¯•æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
.test-mode-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* è¿›åº¦æ¡é…·ç‚«æ•ˆæœ */
.progress-enhanced {
    position: relative;
    overflow: visible !important;
    background: linear-gradient(90deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%) !important;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 2px 10px rgba(0, 0, 0, 0.5);
    border: none !important;
}

.progress-bar-enhanced {
    position: relative;
    background: linear-gradient(90deg,
        #00d4ff 0%,
        #0099ff 25%,
        #6366f1 50%,
        #8b5cf6 75%,
        #a855f7 100%) !important;
    background-size: 200% 100% !important;
    animation: gradientShift 3s ease infinite !important;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.6), 0 0 40px rgba(139, 92, 246, 0.4);
    /* ä½¿ç”¨æ›´é•¿çš„è¿‡æ¸¡æ—¶é—´å’Œæ›´å¹³æ»‘çš„è´å¡å°”æ›²çº¿å®ç°å®Œå…¨å¹³æ»‘ */
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 28px;
    overflow: hidden;
}

/* æ¸å˜æµåŠ¨æ•ˆæœ */
@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* è„‰å†²å…‰æ•ˆ */
.progress-bar-enhanced::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 100%);
    animation: pulse-glow 2s ease-in-out infinite;
}

@keyframes pulse-glow {
    0%, 100% { opacity: 0.3; transform: translateX(-100%); }
    50% { opacity: 0.8; transform: translateX(100%); }
}

/* ç²’å­æ‰«æçº¿æ•ˆæœ */
.progress-bar-enhanced::after {
    content: '';
    position: absolute;
    top: 0;
    left: -50%;
    width: 50%;
    height: 100%;
    background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.8) 50%,
        transparent 100%);
    animation: scan-line 3s linear infinite;
}

@keyframes scan-line {
    0% { left: -50%; }
    100% { left: 150%; }
}

/* è¿›åº¦æ¡å¤–æ¡†å‘å…‰ */
.progress-enhanced::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(90deg, #00d4ff, #6366f1, #a855f7, #00d4ff);
    background-size: 300% 100%;
    animation: border-glow 4s linear infinite;
    border-radius: 14px;
    z-index: -1;
    opacity: 0.7;
}

@keyframes border-glow {
    0% { background-position: 0% 50%; }
    100% { background-position: 300% 50%; }
}

/* è¿›åº¦æ–‡å­—æ ·å¼ */
.progress-text-enhanced {
    position: relative;
    z-index: 10;
    color: #fff;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(99, 102, 241, 0.6);
    font-weight: bold;
    font-size: 0.9rem;
}

/* å®ŒæˆçŠ¶æ€ç‰¹æ•ˆ */
.progress-bar-enhanced.progress-bar-completed {
    background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7, #34d399, #10b981) !important;
    background-size: 200% 100% !important;
    animation: success-pulse 2s ease infinite !important;
    box-shadow: 0 0 30px rgba(16, 185, 129, 0.8) !important;
}

@keyframes success-pulse {
    0%, 100% { background-position: 0% 50%; box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); }
    50% { background-position: 100% 50%; box-shadow: 0 0 40px rgba(16, 185, 129, 0.9); }
}

/* å¤±è´¥çŠ¶æ€ç‰¹æ•ˆ */
.progress-bar-enhanced.progress-bar-failed {
    background: linear-gradient(90deg, #ef4444, #f87171, #fca5a5, #f87171, #ef4444) !important;
    background-size: 200% 100% !important;
    animation: fail-pulse 1.5s ease infinite !important;
    box-shadow: 0 0 30px rgba(239, 68, 68, 0.8) !important;
}

@keyframes fail-pulse {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="bi bi-play-circle"></i> æµ‹è¯•æ‰§è¡Œ
        </h2>
        <p class="text-muted">é…ç½®å’Œè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•</p>
    </div>
</div>

<!-- æµ‹è¯•é…ç½® -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-gear"></i> æµ‹è¯•é…ç½®</span>
                <span class="badge bg-primary" id="selected-count-badge">å·²é€‰æ‹© 0 ä¸ªå•†å“</span>
            </div>
            <div class="card-body">
                <!-- æ­¥éª¤1: é€‰æ‹©æµ‹è¯•èŒƒå›´ -->
                <div class="mb-4">
                    <h6 class="mb-3"><span class="badge bg-secondary me-2">1</span> é€‰æ‹©æµ‹è¯•èŒƒå›´</h6>
                    <div class="row g-2">
                        <div class="col-md-3 col-6">
                            <div class="form-check custom-option-card">
                                <input class="form-check-input" type="radio" name="test-scope" id="scope-all" value="all" checked onchange="updateTestScope()">
                                <label class="form-check-label w-100" for="scope-all">
                                    <div class="card h-100 text-center py-3 scope-card" data-scope="all">
                                        <i class="bi bi-grid-3x3-gap fs-3 text-primary"></i>
                                        <div class="mt-2 fw-bold">æ‰€æœ‰å•†å“</div>
                                        <small class="text-muted">æµ‹è¯•å…¨éƒ¨å•†å“</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="form-check custom-option-card">
                                <input class="form-check-input" type="radio" name="test-scope" id="scope-category" value="category" onchange="updateTestScope()">
                                <label class="form-check-label w-100" for="scope-category">
                                    <div class="card h-100 text-center py-3 scope-card" data-scope="category">
                                        <i class="bi bi-folder fs-3 text-success"></i>
                                        <div class="mt-2 fw-bold">æŒ‰åˆ†ç±»</div>
                                        <small class="text-muted">é€‰æ‹©å•†å“åˆ†ç±»</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="form-check custom-option-card">
                                <input class="form-check-input" type="radio" name="test-scope" id="scope-custom" value="custom" onchange="updateTestScope()">
                                <label class="form-check-label w-100" for="scope-custom">
                                    <div class="card h-100 text-center py-3 scope-card" data-scope="custom">
                                        <i class="bi bi-check2-square fs-3 text-warning"></i>
                                        <div class="mt-2 fw-bold">è‡ªå®šä¹‰é€‰æ‹©</div>
                                        <small class="text-muted">æ‰‹åŠ¨å¤šé€‰å•†å“</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="form-check custom-option-card">
                                <input class="form-check-input" type="radio" name="test-scope" id="scope-single" value="single" onchange="updateTestScope()">
                                <label class="form-check-label w-100" for="scope-single">
                                    <div class="card h-100 text-center py-3 scope-card" data-scope="single">
                                        <i class="bi bi-box-seam fs-3 text-info"></i>
                                        <div class="mt-2 fw-bold">å•ä¸ªå•†å“</div>
                                        <small class="text-muted">æµ‹è¯•æŒ‡å®šå•†å“</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ­¥éª¤2: è¯¦ç»†é…ç½®ï¼ˆæ ¹æ®èŒƒå›´åŠ¨æ€æ˜¾ç¤ºï¼‰ -->
                <div class="mb-4" id="detail-config-section">
                    <!-- åˆ†ç±»é€‰æ‹© -->
                    <div id="category-config" style="display: none;">
                        <h6 class="mb-3"><span class="badge bg-secondary me-2">2</span> é€‰æ‹©å•†å“åˆ†ç±»</h6>
                        <div class="row g-2" id="category-list">
                            <!-- åˆ†ç±»åˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰å¤šé€‰å•†å“ -->
                    <div id="custom-config" style="display: none;">
                        <h6 class="mb-3"><span class="badge bg-secondary me-2">2</span> é€‰æ‹©è¦æµ‹è¯•çš„å•†å“ <small class="text-muted">(æ”¯æŒå¤šé€‰)</small></h6>

                        <!-- æœç´¢å’Œç­›é€‰ -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="custom-search" placeholder="æœç´¢å•†å“åç§°æˆ–ID..." oninput="filterCustomProducts()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="custom-category-filter" onchange="filterCustomProducts()">
                                    <option value="">æ‰€æœ‰åˆ†ç±»</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="btn-group w-100">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllVisible()">å…¨é€‰</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllSelected()">æ¸…ç©º</button>
                                </div>
                            </div>
                        </div>

                        <!-- å•†å“å¤šé€‰åˆ—è¡¨ -->
                        <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;" id="custom-product-list">
                            <!-- å•†å“åˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
                        </div>

                        <!-- å·²é€‰å•†å“æ ‡ç­¾ -->
                        <div class="mt-2" id="selected-products-tags">
                            <!-- å·²é€‰å•†å“æ ‡ç­¾å°†åŠ¨æ€å¡«å…… -->
                        </div>
                    </div>

                    <!-- å•ä¸ªå•†å“é€‰æ‹© -->
                    <div id="single-config" style="display: none;">
                        <h6 class="mb-3"><span class="badge bg-secondary me-2">2</span> é€‰æ‹©å•†å“</h6>
                        <div class="row g-2">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="single-product-search" placeholder="è¾“å…¥å•†å“åç§°æˆ–IDæœç´¢..." autocomplete="off" oninput="filterSingleProducts()">
                                </div>
                                <!-- æœç´¢ç»“æœä¸‹æ‹‰ -->
                                <div class="list-group mt-1 shadow-sm" id="single-product-dropdown" style="display: none; position: absolute; z-index: 1000; max-height: 250px; overflow-y: auto; width: calc(100% - 24px);">
                                    <!-- æœç´¢ç»“æœå°†åŠ¨æ€å¡«å…… -->
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="single-category-filter" onchange="filterSingleProducts()">
                                    <option value="">æ‰€æœ‰åˆ†ç±»</option>
                                </select>
                            </div>
                        </div>
                        <!-- å·²é€‰å•†å“æ˜¾ç¤º -->
                        <div class="mt-3" id="single-selected-product" style="display: none;">
                            <div class="alert alert-info d-flex align-items-center justify-content-between mb-0">
                                <div>
                                    <i class="bi bi-box-seam me-2"></i>
                                    <strong>å·²é€‰æ‹©:</strong> <span id="single-selected-name"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSingleSelection()">
                                    <i class="bi bi-x"></i> å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="single-product-id">
                    </div>
                </div>

                <!-- æ­¥éª¤3: é€‰æ‹©æµ‹è¯•æ¨¡å¼ -->
                <div class="mb-3">
                    <h6 class="mb-3"><span class="badge bg-secondary me-2" id="step3-badge">2</span> é€‰æ‹©æµ‹è¯•æ¨¡å¼</h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-success btn-lg w-100 test-mode-btn" id="btn-quick-test" onclick="runTestWithMode('quick')">
                                <i class="bi bi-lightning-charge"></i> âš¡ å¿«é€Ÿæµ‹è¯•
                                <small class="d-block mt-1" style="font-size: 0.75rem; opacity: 0.9;">æ ¸å¿ƒè´­ç‰©æµç¨‹ï¼ˆ5æ­¥ï¼Œçº¦15-20ç§’/å•†å“ï¼‰</small>
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-primary btn-lg w-100 test-mode-btn" id="btn-full-test" onclick="runTestWithMode('full')">
                                <i class="bi bi-search"></i> ğŸ” å…¨é¢æµ‹è¯•
                                <small class="d-block mt-1" style="font-size: 0.75rem; opacity: 0.9;">å…¨é“¾è·¯åœºæ™¯è¦†ç›–ï¼ˆ12æ­¥ï¼Œçº¦40-60ç§’/å•†å“ï¼‰</small>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetConfig()">
                        <i class="bi bi-arrow-clockwise"></i> é‡ç½®é…ç½®
                    </button>
                    <div class="text-muted small" id="test-estimate">
                        <!-- é¢„ä¼°æµ‹è¯•æ—¶é—´å°†åŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æµ‹è¯•æ‰§è¡ŒçŠ¶æ€ -->
<div class="card mb-4" id="test-execution-card" style="display: none;">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-gear"></i> æµ‹è¯•æ‰§è¡Œä¸­</span>
            <div>
                <span class="badge bg-light text-dark me-2" id="test-elapsed-time">00:00</span>
                <button class="btn btn-sm btn-outline-light" onclick="stopCurrentTest()" title="åœæ­¢æµ‹è¯•">
                    <i class="bi bi-stop-circle"></i> åœæ­¢
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- æ€»ä½“è¿›åº¦ -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="test-status-message">æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...</span>
                <span class="spinner-border spinner-border-sm text-primary" id="test-spinner"></span>
            </div>
            <!-- å¢å¼ºç‰ˆè¿›åº¦æ¡ -->
            <div class="progress progress-enhanced" style="height: 28px;">
                <div class="progress-bar progress-bar-enhanced"
                     id="test-progress-bar"
                     role="progressbar" style="width: 0%">
                    <span id="test-progress-text" class="progress-text-enhanced">0%</span>
                </div>
            </div>
            <!-- è¯¦ç»†è¿›åº¦ä¿¡æ¯ -->
            <div class="d-flex justify-content-between mt-1">
                <small class="text-muted" id="progress-detail-left"></small>
                <small class="text-muted" id="progress-detail-right"></small>
            </div>
        </div>

        <!-- è¯¦ç»†æµ‹è¯•æ­¥éª¤ -->
        <div id="test-steps-container" style="display: none;">
            <h6 class="mb-3">æµ‹è¯•æ­¥éª¤è¯¦æƒ…</h6>
            <div id="test-steps-list">
                <!-- æ­¥éª¤åˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- æ—¥å¿—è¾“å‡ºï¼ˆå¯é€‰å±•å¼€ï¼‰ -->
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleTestLogs()" id="toggle-logs-btn">
                <i class="bi bi-chevron-down"></i> æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
            </button>
            <div id="test-output-log" class="log-output mt-2" style="display: none; max-height: 300px;">
                <!-- å®æ—¶æ—¥å¿—è¾“å‡º -->
            </div>
        </div>
    </div>
</div>

<!-- å½“å‰æµ‹è¯•ç»“æœ -->
<div class="card" id="current-test-results" style="display: none;">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-check-circle"></i> æµ‹è¯•å®Œæˆ</span>
        <div>
            <a href="/reports" class="btn btn-sm btn-light me-2">
                <i class="bi bi-file-earmark-bar-graph"></i> æŸ¥çœ‹æŠ¥å‘Šä¸­å¿ƒ
            </a>
            <button class="btn btn-sm btn-outline-light" onclick="clearCurrentResults()">
                <i class="bi bi-x"></i> å…³é—­
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- æ€»ä½“ç»“æœ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1" id="result-status-icon">âœ“</h3>
                    <p class="text-muted small mb-0">çŠ¶æ€</p>
                    <h5 class="mb-0" id="result-status">PASSED</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">â±ï¸</h3>
                    <p class="text-muted small mb-0">æ€»è€—æ—¶</p>
                    <h5 class="mb-0" id="result-duration">0.00s</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">âœ“</h3>
                    <p class="text-muted small mb-0">é€šè¿‡æ­¥éª¤</p>
                    <h5 class="mb-0"><span id="result-passed">0</span>/<span id="result-total">0</span></h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">âœ—</h3>
                    <p class="text-muted small mb-0">å¤±è´¥æ­¥éª¤</p>
                    <h5 class="mb-0 text-danger" id="result-failed">0</h5>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æ­¥éª¤ -->
        <div id="result-steps-container"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let products = [];
let categories = [];
let selectedProducts = new Set(); // ç”¨äºè‡ªå®šä¹‰å¤šé€‰
let selectedCategory = null;      // ç”¨äºåˆ†ç±»é€‰æ‹©
let singleSelectedProduct = null; // ç”¨äºå•ä¸ªå•†å“é€‰æ‹©
let currentTaskId = null;
let testStartTime = null;
let timerInterval = null;

// æµ‹è¯•æ­¥éª¤é¢„å®šä¹‰ï¼ˆä¸åç«¯scripts/run_product_test.pyä¿æŒä¸€è‡´ï¼‰
const QUICK_TEST_STEPS = [
    { number: 1, name: "é¡µé¢è®¿é—®", description: "è®¿é—®å•†å“é¡µé¢å¹¶æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£å¸¸åŠ è½½" },
    { number: 2, name: "å•†å“ä¿¡æ¯æ˜¾ç¤º", description: "éªŒè¯å•†å“æ ‡é¢˜ã€ä»·æ ¼ç­‰æ ¸å¿ƒä¿¡æ¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤º" },
    { number: 3, name: "æ·»åŠ è´­ç‰©è½¦", description: "ç‚¹å‡»æ·»åŠ è´­ç‰©è½¦æŒ‰é’®ï¼ŒéªŒè¯èƒ½å¦æˆåŠŸåŠ å…¥" },
    { number: 4, name: "è´­ç‰©è½¦éªŒè¯", description: "æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦æœ‰æ–°å¢å•†å“" },
    { number: 5, name: "æ”¯ä»˜æµç¨‹", description: "è®¿é—®è´­ç‰©è½¦é¡µé¢ï¼ŒéªŒè¯CheckoutæŒ‰é’®æ˜¯å¦å¯ç”¨" }
];

const FULL_TEST_STEPS = [
    { number: 1, name: "é¡µé¢è®¿é—®", description: "è®¿é—®å•†å“é¡µé¢å¹¶ç­‰å¾…å®Œå…¨åŠ è½½" },
    { number: 2, name: "é¡µé¢ç»“æ„æ£€æµ‹", description: "æ£€æŸ¥é¡µé¢åŸºç¡€DOMç»“æ„æ˜¯å¦å®Œæ•´" },
    { number: 3, name: "å•†å“æ ‡é¢˜éªŒè¯", description: "éªŒè¯å•†å“æ ‡é¢˜æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®" },
    { number: 4, name: "ä»·æ ¼ä¿¡æ¯éªŒè¯", description: "æ£€æŸ¥å•†å“ä»·æ ¼æ˜¾ç¤ºæ˜¯å¦å®Œæ•´" },
    { number: 5, name: "å•†å“å›¾ç‰‡éªŒè¯", description: "éªŒè¯å•†å“å›¾ç‰‡æ˜¯å¦åŠ è½½æˆåŠŸ" },
    { number: 6, name: "å•†å“æè¿°éªŒè¯", description: "æ£€æŸ¥å•†å“æè¿°å†…å®¹æ˜¯å¦å­˜åœ¨" },
    { number: 7, name: "å˜ä½“é€‰æ‹©æµ‹è¯•", description: "æµ‹è¯•é¢œè‰²/å°ºå¯¸ç­‰å˜ä½“é€‰é¡¹åŠŸèƒ½" },
    { number: 8, name: "æ•°é‡é€‰æ‹©æµ‹è¯•", description: "æµ‹è¯•å•†å“æ•°é‡å¢å‡åŠŸèƒ½" },
    { number: 9, name: "æ·»åŠ è´­ç‰©è½¦", description: "æµ‹è¯•æ·»åŠ è´­ç‰©è½¦åŠŸèƒ½" },
    { number: 10, name: "è´­ç‰©è½¦éªŒè¯", description: "éªŒè¯è´­ç‰©è½¦å•†å“æ•°é‡å˜åŒ–" },
    { number: 11, name: "ç›¸å…³æ¨èéªŒè¯", description: "æ£€æŸ¥ç›¸å…³å•†å“æ¨èæ˜¯å¦æ˜¾ç¤º" },
    { number: 12, name: "æ”¯ä»˜æµç¨‹éªŒè¯", description: "éªŒè¯ä»è´­ç‰©è½¦åˆ°æ”¯ä»˜é¡µé¢çš„å®Œæ•´æµç¨‹" }
];

let currentTestMode = null;

// è¿›åº¦æ¡å¹³æ»‘æ’å€¼ç›¸å…³å˜é‡
let currentDisplayProgress = 0;  // å½“å‰æ˜¾ç¤ºçš„è¿›åº¦ç™¾åˆ†æ¯”
let targetProgress = 0;          // ç›®æ ‡è¿›åº¦ç™¾åˆ†æ¯”
let progressAnimationFrame = null;  // åŠ¨ç”»å¸§ID
let totalExpectedSteps = 0;      // é¢„æœŸæ€»æ­¥éª¤æ•°
let totalExpectedProducts = 0;   // é¢„æœŸå•†å“æ€»æ•°

// æ­¥éª¤é—´å¾®è¿›åº¦åŠ¨ç”»ç›¸å…³å˜é‡
let microProgressInterval = null;   // å¾®è¿›åº¦å®šæ—¶å™¨
let lastKnownProgress = 0;          // ä¸Šæ¬¡å·²çŸ¥çš„çœŸå®è¿›åº¦
let microProgressIncrement = 1.8;   // æ¯æ¬¡å¾®å¢é‡ï¼ˆç™¾åˆ†æ¯”ï¼‰- 12å€é€Ÿæ›´å¿«æ¨è¿›
let microProgressMaxGap = 12;       // æœ€å¤§æå‰æ¨è¿›é‡ï¼ˆä¸è¶…è¿‡ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼‰

// ä¼šè¯çŠ¶æ€æŒä¹…åŒ– - ç”¨äºæ ‡ç­¾é¡µåˆ‡æ¢æ¢å¤
const TEST_STATE_KEY = 'fiido_active_test_state';

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('single-product-dropdown');
        const searchInput = document.getElementById('single-product-search');
        if (dropdown && !dropdown.contains(e.target) && e.target !== searchInput) {
            dropdown.style.display = 'none';
        }
    });

    // ğŸ”§ æ–°å¢: æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•éœ€è¦æ¢å¤
    checkAndRestoreActiveTest();
});

// ğŸ”§ æ–°å¢: æ£€æŸ¥å¹¶æ¢å¤æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•
async function checkAndRestoreActiveTest() {
    // 1. å…ˆæ£€æŸ¥åç«¯æ˜¯å¦æœ‰æ´»è·ƒæµ‹è¯•
    try {
        const response = await fetch('/api/tests/active');
        const data = await response.json();

        if (data.has_active) {
            console.log('[æ¢å¤æµ‹è¯•] æ£€æµ‹åˆ°åç«¯æœ‰æ´»è·ƒæµ‹è¯•:', data.task_id);

            // æ¢å¤æµ‹è¯•çŠ¶æ€
            currentTaskId = data.task_id;
            currentTestMode = data.test_mode || 'quick';
            testStartTime = new Date(data.started_at).getTime();

            // æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€å¡ç‰‡
            showTestExecutionCard(true); // true = æ¢å¤æ¨¡å¼ï¼Œä¸é‡ç½®è¿›åº¦

            // æ¢å¤è½®è¯¢
            utils.pollTaskStatus(currentTaskId, updateTestStatus, onTestComplete);

            utils.showToast('å·²æ¢å¤æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•', 'info');
            return;
        }
    } catch (error) {
        console.error('[æ¢å¤æµ‹è¯•] æ£€æŸ¥åç«¯çŠ¶æ€å¤±è´¥:', error);
    }

    // 2. æ£€æŸ¥sessionStorageä¸­æ˜¯å¦æœ‰ä¿å­˜çš„çŠ¶æ€ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
    try {
        const savedState = sessionStorage.getItem(TEST_STATE_KEY);
        if (savedState) {
            const state = JSON.parse(savedState);

            // æ£€æŸ¥çŠ¶æ€æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡30åˆ†é’Ÿè§†ä¸ºè¿‡æœŸï¼‰
            const savedTime = new Date(state.savedAt).getTime();
            const now = Date.now();
            if (now - savedTime > 30 * 60 * 1000) {
                console.log('[æ¢å¤æµ‹è¯•] ä¿å­˜çš„çŠ¶æ€å·²è¿‡æœŸï¼Œæ¸…é™¤');
                sessionStorage.removeItem(TEST_STATE_KEY);
                return;
            }

            // éªŒè¯ä»»åŠ¡æ˜¯å¦ä»åœ¨è¿è¡Œ
            const statusResponse = await fetch(`/api/tests/status/${state.taskId}`);
            if (statusResponse.ok) {
                const statusData = await statusResponse.json();
                if (statusData.status === 'running') {
                    console.log('[æ¢å¤æµ‹è¯•] ä»sessionStorageæ¢å¤æµ‹è¯•:', state.taskId);

                    currentTaskId = state.taskId;
                    currentTestMode = state.testMode || 'quick';
                    testStartTime = state.startTime;

                    showTestExecutionCard(true);
                    utils.pollTaskStatus(currentTaskId, updateTestStatus, onTestComplete);

                    utils.showToast('å·²æ¢å¤æ­£åœ¨è¿›è¡Œçš„æµ‹è¯•', 'info');
                } else {
                    // ä»»åŠ¡å·²å®Œæˆï¼Œæ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                    sessionStorage.removeItem(TEST_STATE_KEY);
                }
            }
        }
    } catch (error) {
        console.error('[æ¢å¤æµ‹è¯•] æ¢å¤çŠ¶æ€å¤±è´¥:', error);
        sessionStorage.removeItem(TEST_STATE_KEY);
    }
}

// ğŸ”§ æ–°å¢: ä¿å­˜æµ‹è¯•çŠ¶æ€åˆ°sessionStorage
function saveTestState() {
    if (!currentTaskId) return;

    const state = {
        taskId: currentTaskId,
        testMode: currentTestMode,
        startTime: testStartTime,
        savedAt: new Date().toISOString()
    };

    sessionStorage.setItem(TEST_STATE_KEY, JSON.stringify(state));
    console.log('[çŠ¶æ€ä¿å­˜] å·²ä¿å­˜æµ‹è¯•çŠ¶æ€:', state);
}

// ğŸ”§ æ–°å¢: æ¸…é™¤ä¿å­˜çš„æµ‹è¯•çŠ¶æ€
function clearTestState() {
    sessionStorage.removeItem(TEST_STATE_KEY);
    console.log('[çŠ¶æ€æ¸…é™¤] å·²æ¸…é™¤æµ‹è¯•çŠ¶æ€');
}

// åŠ è½½å•†å“åˆ—è¡¨
async function loadProducts() {
    try {
        const response = await fetch('/api/products/list');
        const data = await response.json();
        products = data.products || [];

        // æå–æ‰€æœ‰åˆ†ç±»
        categories = [...new Set(products.map(p => p.category).filter(c => c))].sort();

        // åˆå§‹åŒ–å„ä¸ªé…ç½®åŒºåŸŸ
        initCategoryList();
        initCustomProductList();
        initCategoryFilters();

        // æ›´æ–°é€‰æ‹©è®¡æ•°
        updateSelectedCount();
        updateTestEstimate();

        // æ£€æŸ¥URLå‚æ•°ï¼Œè‡ªåŠ¨é€‰æ‹©å•†å“
        checkUrlParams();
    } catch (error) {
        console.error('åŠ è½½å•†å“å¤±è´¥:', error);
        utils.showToast('åŠ è½½å•†å“åˆ—è¡¨å¤±è´¥', 'error');
    }
}

// æ£€æŸ¥URLå‚æ•°ï¼Œè‡ªåŠ¨é€‰æ‹©å•†å“
function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product_id');

    if (productId) {
        // æ‰¾åˆ°å¯¹åº”å•†å“
        const product = products.find(p => p.id === productId || String(p.id) === productId);
        if (product) {
            // åˆ‡æ¢åˆ°å•ä¸ªå•†å“æ¨¡å¼
            document.getElementById('scope-single').checked = true;
            updateTestScope();

            // è‡ªåŠ¨é€‰æ‹©è¯¥å•†å“ï¼ˆç›´æ¥æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸­ï¼‰
            selectSingleProduct(product.id);
        } else {
            // å•†å“ä¸å­˜åœ¨æ—¶ç»™äºˆæç¤º
            utils.showToast(`æœªæ‰¾åˆ°å•†å“ID: ${productId}ï¼Œè¯·æ£€æŸ¥IDæ˜¯å¦æ­£ç¡®`, 'warning');
        }
    }
}

// åˆå§‹åŒ–åˆ†ç±»åˆ—è¡¨ï¼ˆç”¨äº"æŒ‰åˆ†ç±»"é€‰æ‹©ï¼‰
function initCategoryList() {
    const container = document.getElementById('category-list');
    if (!container) return;

    container.innerHTML = categories.map(category => {
        const count = products.filter(p => p.category === category).length;
        return `
            <div class="col-md-4 col-6">
                <div class="card category-card p-3 ${selectedCategory === category ? 'selected' : ''}"
                     onclick="toggleCategory('${escapeHtml(category)}')"
                     data-category="${escapeHtml(category)}">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-folder2 fs-4 text-success me-2"></i>
                        <div>
                            <div class="fw-bold">${escapeHtml(category)}</div>
                            <small class="text-muted">${count} ä¸ªå•†å“</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// åˆ‡æ¢åˆ†ç±»é€‰æ‹©
function toggleCategory(category) {
    if (selectedCategory === category) {
        selectedCategory = null;
    } else {
        selectedCategory = category;
    }

    // æ›´æ–°UI
    document.querySelectorAll('.category-card').forEach(card => {
        if (card.dataset.category === selectedCategory) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });

    updateSelectedCount();
    updateTestEstimate();
}

// åˆå§‹åŒ–è‡ªå®šä¹‰å•†å“å¤šé€‰åˆ—è¡¨
function initCustomProductList() {
    renderCustomProductList(products);
}

// æ¸²æŸ“è‡ªå®šä¹‰å•†å“åˆ—è¡¨
function renderCustomProductList(filteredProducts) {
    const container = document.getElementById('custom-product-list');
    if (!container) return;

    if (filteredProducts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å•†å“</div>';
        return;
    }

    container.innerHTML = filteredProducts.map(product => `
        <div class="form-check product-check-item" data-product-id="${product.id}" data-category="${product.category || ''}">
            <input class="form-check-input" type="checkbox" id="product-${product.id}"
                   ${selectedProducts.has(product.id) ? 'checked' : ''}
                   onchange="toggleProductSelection('${product.id}')">
            <label class="form-check-label d-flex justify-content-between w-100" for="product-${product.id}">
                <span>
                    <strong>${escapeHtml(product.name)}</strong>
                    <small class="text-muted ms-2">${product.id}</small>
                </span>
                <span class="badge bg-secondary">${escapeHtml(product.category || 'æœªåˆ†ç±»')}</span>
            </label>
        </div>
    `).join('');
}

// åˆ‡æ¢å•†å“é€‰æ‹©çŠ¶æ€
function toggleProductSelection(productId) {
    if (selectedProducts.has(productId)) {
        selectedProducts.delete(productId);
    } else {
        selectedProducts.add(productId);
    }
    updateSelectedTags();
    updateSelectedCount();
    updateTestEstimate();
}

// æ›´æ–°å·²é€‰å•†å“æ ‡ç­¾
function updateSelectedTags() {
    const container = document.getElementById('selected-products-tags');
    if (!container) return;

    if (selectedProducts.size === 0) {
        container.innerHTML = '';
        return;
    }

    const tags = Array.from(selectedProducts).map(productId => {
        const product = products.find(p => p.id === productId);
        const name = product ? product.name : productId;
        return `
            <span class="selected-tag">
                ${escapeHtml(name.length > 20 ? name.substring(0, 20) + '...' : name)}
                <span class="remove-tag" onclick="toggleProductSelection('${productId}')"><i class="bi bi-x"></i></span>
            </span>
        `;
    }).join('');

    container.innerHTML = `<div class="mt-2"><strong>å·²é€‰æ‹© ${selectedProducts.size} ä¸ªå•†å“:</strong></div>` + tags;
}

// ç­›é€‰è‡ªå®šä¹‰å•†å“åˆ—è¡¨
function filterCustomProducts() {
    const searchTerm = document.getElementById('custom-search').value.toLowerCase().trim();
    const categoryFilter = document.getElementById('custom-category-filter').value;

    const filtered = products.filter(p => {
        const matchSearch = !searchTerm ||
            p.name.toLowerCase().includes(searchTerm) ||
            p.id.toLowerCase().includes(searchTerm);
        const matchCategory = !categoryFilter || p.category === categoryFilter;
        return matchSearch && matchCategory;
    });

    renderCustomProductList(filtered);
}

// å…¨é€‰å½“å‰å¯è§å•†å“
function selectAllVisible() {
    const visibleItems = document.querySelectorAll('#custom-product-list .product-check-item');
    visibleItems.forEach(item => {
        const productId = item.dataset.productId;
        selectedProducts.add(productId);
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = true;
    });
    updateSelectedTags();
    updateSelectedCount();
    updateTestEstimate();
}

// æ¸…ç©ºæ‰€æœ‰é€‰æ‹©
function clearAllSelected() {
    selectedProducts.clear();
    document.querySelectorAll('#custom-product-list input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    updateSelectedTags();
    updateSelectedCount();
    updateTestEstimate();
}

// åˆå§‹åŒ–åˆ†ç±»ç­›é€‰ä¸‹æ‹‰æ¡†
function initCategoryFilters() {
    const filters = ['custom-category-filter', 'single-category-filter'];
    filters.forEach(filterId => {
        const select = document.getElementById(filterId);
        if (select) {
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
            select.innerHTML = '<option value="">æ‰€æœ‰åˆ†ç±»</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }
    });
}

// ç­›é€‰å•ä¸ªå•†å“åˆ—è¡¨
function filterSingleProducts() {
    const searchTerm = document.getElementById('single-product-search').value.toLowerCase().trim();
    const categoryFilter = document.getElementById('single-category-filter').value;
    const dropdown = document.getElementById('single-product-dropdown');

    if (!searchTerm && !categoryFilter) {
        dropdown.style.display = 'none';
        return;
    }

    const filtered = products.filter(p => {
        const matchSearch = !searchTerm ||
            p.name.toLowerCase().includes(searchTerm) ||
            p.id.toLowerCase().includes(searchTerm);
        const matchCategory = !categoryFilter || p.category === categoryFilter;
        return matchSearch && matchCategory;
    }).slice(0, 20); // æœ€å¤šæ˜¾ç¤º20ä¸ªç»“æœ

    if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="p-3 text-muted text-center">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å•†å“</div>';
    } else {
        dropdown.innerHTML = filtered.map(product => `
            <div class="product-dropdown-item" onclick="selectSingleProduct('${product.id}')">
                <div class="fw-bold">${escapeHtml(product.name)}</div>
                <small class="text-muted">${product.id} Â· ${escapeHtml(product.category || 'æœªåˆ†ç±»')}</small>
            </div>
        `).join('');
    }
    dropdown.style.display = 'block';
}

// é€‰æ‹©å•ä¸ªå•†å“
function selectSingleProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    singleSelectedProduct = product;
    document.getElementById('single-product-id').value = productId;

    // ç›´æ¥åœ¨è¾“å…¥æ¡†æ˜¾ç¤ºå•†å“å…¨ç§°ï¼Œæ— éœ€å¼¹å‡ºæç¤º
    document.getElementById('single-product-search').value = product.name;
    document.getElementById('single-product-dropdown').style.display = 'none';

    // éšè—å·²é€‰å•†å“æç¤ºåŒºåŸŸï¼ˆä¸å†éœ€è¦å•ç‹¬æ˜¾ç¤ºï¼‰
    document.getElementById('single-selected-product').style.display = 'none';

    updateSelectedCount();
    updateTestEstimate();
}

// æ¸…é™¤å•ä¸ªå•†å“é€‰æ‹©
function clearSingleSelection() {
    singleSelectedProduct = null;
    document.getElementById('single-product-id').value = '';
    document.getElementById('single-product-search').value = '';
    document.getElementById('single-selected-product').style.display = 'none';

    updateSelectedCount();
    updateTestEstimate();
}

// æ›´æ–°æµ‹è¯•èŒƒå›´æ˜¾ç¤º
function updateTestScope() {
    const scope = document.querySelector('input[name="test-scope"]:checked').value;

    // éšè—æ‰€æœ‰é…ç½®åŒºåŸŸ
    document.getElementById('category-config').style.display = 'none';
    document.getElementById('custom-config').style.display = 'none';
    document.getElementById('single-config').style.display = 'none';

    // æ›´æ–°æ­¥éª¤ç¼–å·
    const step3Badge = document.getElementById('step3-badge');

    if (scope === 'all') {
        step3Badge.textContent = '2';
    } else if (scope === 'category') {
        document.getElementById('category-config').style.display = 'block';
        step3Badge.textContent = '3';
    } else if (scope === 'custom') {
        document.getElementById('custom-config').style.display = 'block';
        step3Badge.textContent = '3';
    } else if (scope === 'single') {
        document.getElementById('single-config').style.display = 'block';
        step3Badge.textContent = '3';
    }

    updateSelectedCount();
    updateTestEstimate();
}

// è·å–å½“å‰é€‰æ‹©çš„å•†å“æ•°é‡
function getSelectedProductCount() {
    const scope = document.querySelector('input[name="test-scope"]:checked').value;

    if (scope === 'all') {
        return products.length;
    } else if (scope === 'category') {
        if (!selectedCategory) return 0;
        return products.filter(p => p.category === selectedCategory).length;
    } else if (scope === 'custom') {
        return selectedProducts.size;
    } else if (scope === 'single') {
        return singleSelectedProduct ? 1 : 0;
    }
    return 0;
}

// è·å–å½“å‰é€‰æ‹©çš„å•†å“IDåˆ—è¡¨
function getSelectedProductIds() {
    const scope = document.querySelector('input[name="test-scope"]:checked').value;

    if (scope === 'all') {
        return products.map(p => p.id);
    } else if (scope === 'category') {
        if (!selectedCategory) return [];
        return products.filter(p => p.category === selectedCategory).map(p => p.id);
    } else if (scope === 'custom') {
        return Array.from(selectedProducts);
    } else if (scope === 'single') {
        return singleSelectedProduct ? [singleSelectedProduct.id] : [];
    }
    return [];
}

// æ›´æ–°é€‰æ‹©è®¡æ•°å¾½ç« 
function updateSelectedCount() {
    const count = getSelectedProductCount();
    const badge = document.getElementById('selected-count-badge');
    if (badge) {
        badge.textContent = `å·²é€‰æ‹© ${count} ä¸ªå•†å“`;
        badge.className = count > 0 ? 'badge bg-primary' : 'badge bg-secondary';
    }

    // æ›´æ–°æµ‹è¯•æŒ‰é’®çŠ¶æ€
    const btnQuick = document.getElementById('btn-quick-test');
    const btnFull = document.getElementById('btn-full-test');
    if (btnQuick) btnQuick.disabled = count === 0;
    if (btnFull) btnFull.disabled = count === 0;
}

// æ›´æ–°æµ‹è¯•æ—¶é—´é¢„ä¼°
function updateTestEstimate() {
    const count = getSelectedProductCount();
    const estimateDiv = document.getElementById('test-estimate');
    if (!estimateDiv) return;

    if (count === 0) {
        estimateDiv.innerHTML = '';
        return;
    }

    const quickTime = count * 20; // å¿«é€Ÿæµ‹è¯•çº¦20ç§’/å•†å“
    const fullTime = count * 50;  // å…¨é¢æµ‹è¯•çº¦50ç§’/å•†å“

    estimateDiv.innerHTML = `
        <i class="bi bi-clock"></i>
        é¢„ä¼°æ—¶é—´: å¿«é€Ÿ ${formatTime(quickTime)} / å…¨é¢ ${formatTime(fullTime)}
    `;
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(seconds) {
    if (seconds < 60) return `${seconds}ç§’`;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return secs > 0 ? `${mins}åˆ†${secs}ç§’` : `${mins}åˆ†é’Ÿ`;
}

// é‡ç½®é…ç½®
function resetConfig() {
    // é‡ç½®èŒƒå›´é€‰æ‹©
    document.getElementById('scope-all').checked = true;

    // æ¸…ç©ºå„ç§é€‰æ‹©
    selectedProducts.clear();
    selectedCategory = null;
    singleSelectedProduct = null;

    // é‡ç½®UI
    document.getElementById('custom-search').value = '';
    document.getElementById('single-product-search').value = '';
    document.getElementById('single-product-id').value = '';
    document.getElementById('single-selected-product').style.display = 'none';

    // é‡ç½®åˆ†ç±»å¡ç‰‡
    document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('selected');
    });

    // é‡ç½®å•†å“å¤é€‰æ¡†
    document.querySelectorAll('#custom-product-list input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });

    // æ¸…ç©ºå·²é€‰æ ‡ç­¾
    document.getElementById('selected-products-tags').innerHTML = '';

    // æ›´æ–°ç•Œé¢
    updateTestScope();
    updateSelectedCount();
    updateTestEstimate();

    utils.showToast('é…ç½®å·²é‡ç½®', 'info');
}

// ä½¿ç”¨æŒ‡å®šæ¨¡å¼è¿è¡Œæµ‹è¯•
async function runTestWithMode(mode) {
    const productIds = getSelectedProductIds();

    if (productIds.length === 0) {
        utils.showToast('è¯·å…ˆé€‰æ‹©è¦æµ‹è¯•çš„å•†å“', 'warning');
        return;
    }

    currentTestMode = mode;

    const scope = document.querySelector('input[name="test-scope"]:checked').value;
    const params = { test_mode: mode };

    // æ ¹æ®é€‰æ‹©èŒƒå›´è®¾ç½®å‚æ•°
    if (scope === 'all') {
        // æµ‹è¯•æ‰€æœ‰å•†å“ï¼Œä¸ä¼ é¢å¤–å‚æ•°
    } else if (scope === 'category' && selectedCategory) {
        params.category = selectedCategory;
    } else if (scope === 'custom' && selectedProducts.size > 0) {
        // è‡ªå®šä¹‰å¤šé€‰ï¼šä¼ é€’å•†å“IDåˆ—è¡¨
        params.product_ids = Array.from(selectedProducts);
    } else if (scope === 'single' && singleSelectedProduct) {
        params.product_id = singleSelectedProduct.id;
    }

    startTestExecution(params);
}

// å¼€å§‹æµ‹è¯•æ‰§è¡Œ
async function startTestExecution(params) {
    try {
        const response = await fetch('/api/tests/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });

        const data = await response.json();

        // å¤„ç†æµ‹è¯•å†²çª
        if (response.status === 409 && data.conflict) {
            handleTestConflict(data, params);
            return;
        }

        currentTaskId = data.task_id;

        // æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€å¡ç‰‡
        showTestExecutionCard();

        // å¼€å§‹è½®è¯¢çŠ¶æ€
        utils.pollTaskStatus(currentTaskId, updateTestStatus, onTestComplete);

    } catch (error) {
        utils.showToast('å¯åŠ¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
    }
}

// å¤„ç†æµ‹è¯•å†²çª
function handleTestConflict(conflictData, newParams) {
    const startedAt = new Date(conflictData.active_task_started).toLocaleString('zh-CN');
    const activeMode = conflictData.active_task_params.test_mode === 'quick' ? 'å¿«é€Ÿæµ‹è¯•' : 'å…¨é¢æµ‹è¯•';

    // æ˜¾ç¤ºå†²çªå¯¹è¯æ¡†
    const modalHtml = `
        <div class="modal fade" id="conflictModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle"></i> æµ‹è¯•ä»»åŠ¡å†²çª
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>å½“å‰å·²æœ‰æµ‹è¯•æ­£åœ¨è¿è¡Œï¼š</p>
                        <div class="alert alert-info">
                            <strong>ä»»åŠ¡ID:</strong> ${conflictData.active_task_id}<br>
                            <strong>å¼€å§‹æ—¶é—´:</strong> ${startedAt}<br>
                            <strong>æµ‹è¯•æ¨¡å¼:</strong> ${activeMode}
                        </div>
                        <p>è¯·é€‰æ‹©æ“ä½œï¼š</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            ç»§ç»­å½“å‰æµ‹è¯•
                        </button>
                        <button type="button" class="btn btn-danger" onclick="stopAndStartNew('${conflictData.active_task_id}')">
                            åœæ­¢æ—§æµ‹è¯•ï¼Œå¼€å§‹æ–°æµ‹è¯•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ç§»é™¤æ—§modal
    const oldModal = document.getElementById('conflictModal');
    if (oldModal) oldModal.remove();

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // ä¿å­˜æ–°æµ‹è¯•å‚æ•°
    window.pendingTestParams = newParams;

    const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
    modal.show();
}

// åœæ­¢æ—§æµ‹è¯•å¹¶å¼€å§‹æ–°æµ‹è¯•
async function stopAndStartNew(oldTaskId) {
    // å…³é—­å¯¹è¯æ¡†
    const modal = bootstrap.Modal.getInstance(document.getElementById('conflictModal'));
    if (modal) modal.hide();

    utils.showToast('æ­£åœ¨åœæ­¢æ—§æµ‹è¯•...', 'info');

    try {
        // åœæ­¢æ—§æµ‹è¯•
        await fetch(`/api/tests/stop/${oldTaskId}`, { method: 'POST' });

        // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿åœæ­¢
        await new Promise(resolve => setTimeout(resolve, 1000));

        // å¼€å§‹æ–°æµ‹è¯•
        if (window.pendingTestParams) {
            startTestExecution(window.pendingTestParams);
            window.pendingTestParams = null;
        }
    } catch (error) {
        utils.showToast('åœæ­¢æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
    }
}

// æ‰‹åŠ¨åœæ­¢å½“å‰æµ‹è¯•
async function stopCurrentTest() {
    if (!currentTaskId) {
        utils.showToast('æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æµ‹è¯•', 'warning');
        return;
    }

    if (!confirm('ç¡®å®šè¦åœæ­¢å½“å‰æµ‹è¯•å—ï¼Ÿåœæ­¢åå°†ä¸ä¼šç”Ÿæˆæµ‹è¯•æŠ¥å‘Šã€‚')) {
        return;
    }

    try {
        const response = await fetch(`/api/tests/stop/${currentTaskId}`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            utils.showToast('æµ‹è¯•å·²åœæ­¢', 'info');

            // ğŸ”§ æ–°å¢: åœæ­¢å¾®è¿›åº¦åŠ¨ç”»
            if (microProgressInterval) {
                clearInterval(microProgressInterval);
                microProgressInterval = null;
            }

            // ğŸ”§ æ–°å¢: æ¸…é™¤ä¿å­˜çš„æµ‹è¯•çŠ¶æ€
            clearTestState();

            hideTestExecutionCard();

            // æ˜¾ç¤ºåœæ­¢çŠ¶æ€
            const message = document.getElementById('test-status-message');
            if (message) {
                message.textContent = 'âŠ˜ æµ‹è¯•å·²è¢«ç”¨æˆ·åœæ­¢';
            }
        } else {
            utils.showToast('åœæ­¢æµ‹è¯•å¤±è´¥', 'error');
        }
    } catch (error) {
        utils.showToast('åœæ­¢æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
    }
}

// æ˜¾ç¤ºæµ‹è¯•æ‰§è¡Œå¡ç‰‡
function showTestExecutionCard(isRestoreMode = false) {
    const card = document.getElementById('test-execution-card');
    card.style.display = 'block';

    // ğŸ”§ v3.1.0: æ–°æµ‹è¯•å¼€å§‹æ—¶ï¼Œè‡ªåŠ¨å…³é—­æ—§çš„æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼Œé¿å…æ··æ·†
    const resultsCard = document.getElementById('current-test-results');
    if (resultsCard) {
        resultsCard.style.display = 'none';
    }

    // åªåœ¨éæ¢å¤æ¨¡å¼ä¸‹é‡ç½®è¿›åº¦æ¡çŠ¶æ€
    if (!isRestoreMode) {
        // é‡ç½®è¿›åº¦æ¡çŠ¶æ€å˜é‡
        currentDisplayProgress = 0;
        targetProgress = 0;
        totalExpectedSteps = 0;
        totalExpectedProducts = 0;
        lastKnownProgress = 0;
    }

    // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»
    if (progressAnimationFrame) {
        cancelAnimationFrame(progressAnimationFrame);
        progressAnimationFrame = null;
    }

    // åœæ­¢åˆå§‹åŒ–è¿›åº¦åŠ¨ç”»ï¼ˆå¦‚æœæœ‰ï¼‰
    if (initProgressInterval) {
        clearInterval(initProgressInterval);
        initProgressInterval = null;
    }

    // åœæ­¢å¾®è¿›åº¦åŠ¨ç”»ï¼ˆå¦‚æœæœ‰ï¼‰
    if (microProgressInterval) {
        clearInterval(microProgressInterval);
        microProgressInterval = null;
    }

    // é‡ç½®è¿›åº¦æ¡æ ·å¼å’Œå†…å®¹
    const progressBar = document.getElementById('test-progress-bar');
    const progressText = document.getElementById('test-progress-text');

    // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€ç±»
    progressBar.className = 'progress-bar progress-bar-enhanced';

    if (!isRestoreMode) {
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
    }

    // é‡ç½®è¯¦ç»†ä¿¡æ¯
    const detailLeft = document.getElementById('progress-detail-left');
    const detailRight = document.getElementById('progress-detail-right');
    if (detailLeft) detailLeft.textContent = isRestoreMode ? 'æ¢å¤ä¸­...' : 'å‡†å¤‡ä¸­...';
    if (detailRight) detailRight.textContent = '';

    // é‡ç½®spinner
    const spinner = document.getElementById('test-spinner');
    if (spinner) spinner.style.display = '';

    // æ¢å¤æ¨¡å¼ä¸‹ä½¿ç”¨ä¿å­˜çš„startTimeï¼Œå¦åˆ™ä½¿ç”¨å½“å‰æ—¶é—´
    if (!isRestoreMode) {
        testStartTime = Date.now();
    }

    updateElapsedTime();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateElapsedTime, 1000);

    // ä¸é¢„å…ˆæ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤ï¼Œåªæ˜¾ç¤ºç©ºçš„æ­¥éª¤å®¹å™¨
    const container = document.getElementById('test-steps-container');
    const stepsList = document.getElementById('test-steps-list');
    container.style.display = 'block';
    stepsList.innerHTML = `<div class="text-muted text-center py-3"><span class="spinner-border spinner-border-sm me-2"></span>${isRestoreMode ? 'æ­£åœ¨æ¢å¤æµ‹è¯•çŠ¶æ€...' : 'æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•...'}</div>`;

    // æ»šåŠ¨åˆ°æ‰§è¡Œå¡ç‰‡
    card.scrollIntoView({ behavior: 'smooth' });

    // åªåœ¨éæ¢å¤æ¨¡å¼ä¸‹å¯åŠ¨åˆå§‹åŒ–é˜¶æ®µçš„è¿›åº¦åŠ¨ç”»
    if (!isRestoreMode) {
        startInitializationProgress();
    }

    // ğŸ”§ æ–°å¢: ä¿å­˜æµ‹è¯•çŠ¶æ€
    saveTestState();

    // ğŸ”§ æ–°å¢: å¯åŠ¨å¾®è¿›åº¦åŠ¨ç”»
    startMicroProgressAnimation();
}

// åˆå§‹åŒ–é˜¶æ®µè¿›åº¦åŠ¨ç”»å®šæ—¶å™¨
let initProgressInterval = null;
let initProgressTarget = 8; // åˆå§‹åŒ–é˜¶æ®µæœ€å¤§æ¨è¿›åˆ°8%
let initProgressStartTime = null; // åˆå§‹åŒ–å¼€å§‹æ—¶é—´
const INIT_PROGRESS_TIMEOUT = 10000; // 10ç§’è¶…æ—¶ï¼šå¦‚æœ10ç§’å†…çœŸå®è¿›åº¦è¿˜æ²¡å¼€å§‹ï¼Œåœæ­¢åˆå§‹åŒ–åŠ¨ç”»

// å¯åŠ¨åˆå§‹åŒ–è¿›åº¦åŠ¨ç”»
function startInitializationProgress() {
    initProgressStartTime = Date.now();
    let initProgress = 0;

    initProgressInterval = setInterval(() => {
        // æ£€æŸ¥æ˜¯å¦å·²è¶…æ—¶
        const elapsed = Date.now() - initProgressStartTime;
        if (elapsed > INIT_PROGRESS_TIMEOUT) {
            // è¶…æ—¶ï¼šåœæ­¢åˆå§‹åŒ–åŠ¨ç”»ï¼Œç­‰å¾…çœŸå®æ•°æ®
            clearInterval(initProgressInterval);
            initProgressInterval = null;
            console.log('[è¿›åº¦æ¡] åˆå§‹åŒ–åŠ¨ç”»è¶…æ—¶ï¼Œç­‰å¾…çœŸå®è¿›åº¦æ•°æ®');
            return;
        }

        // å¦‚æœçœŸå®è¿›åº¦å·²ç»å¼€å§‹ï¼ˆtargetProgress > initProgressTargetï¼‰ï¼Œåœæ­¢åˆå§‹åŒ–åŠ¨ç”»
        if (targetProgress > initProgressTarget) {
            clearInterval(initProgressInterval);
            initProgressInterval = null;
            console.log('[è¿›åº¦æ¡] çœŸå®è¿›åº¦å·²åˆ°è¾¾ï¼Œåœæ­¢åˆå§‹åŒ–åŠ¨ç”»');
            return;
        }

        // ç¼“æ…¢å¢åŠ åˆ°initProgressTarget
        if (initProgress < initProgressTarget) {
            // è¶Šæ¥è¿‘ç›®æ ‡è¶Šæ…¢ï¼ˆæ¨¡æ‹ŸåŠ è½½æ•ˆæœï¼‰- é€Ÿåº¦æå‡2.5å€
            const remaining = initProgressTarget - initProgress;
            const increment = Math.max(0.2, remaining * 0.2);
            initProgress = Math.min(initProgressTarget, initProgress + increment);

            // è°ƒç”¨setProgressWithAnimationï¼Œç”±äº"åªè¿›ä¸é€€"æœºåˆ¶ï¼Œè¿›åº¦åªä¼šå¾€å‰èµ°
            setProgressWithAnimation(initProgress);
        }
    }, 200);
}

// ğŸ”§ æ–°å¢: å¯åŠ¨æ­¥éª¤é—´å¾®è¿›åº¦åŠ¨ç”» - åœ¨æ­¥éª¤æ‰§è¡Œè¿‡ç¨‹ä¸­å¹³æ»‘æ¨è¿›è¿›åº¦æ¡
// ğŸ”§ ä¿®å¤v3.1.0: é¿å…é—ªçƒï¼Œåªåœ¨çœŸå®è¿›åº¦æ›´æ–°é—´éš”è¾ƒé•¿æ—¶æ‰å¾®è°ƒ
function startMicroProgressAnimation() {
    // æ¸…é™¤å·²æœ‰çš„å¾®è¿›åº¦åŠ¨ç”»
    if (microProgressInterval) {
        clearInterval(microProgressInterval);
    }

    let lastMicroUpdateTime = Date.now();
    const MIN_UPDATE_INTERVAL = 2000; // è‡³å°‘2ç§’ä¸æ›´æ–°æ‰å¼€å§‹å¾®è¿›åº¦

    microProgressInterval = setInterval(() => {
        // å¦‚æœæ²¡æœ‰ç›®æ ‡è¿›åº¦æˆ–å·²è¾¾åˆ°95%ä»¥ä¸Šï¼Œä¸å†å¾®è°ƒ
        if (targetProgress >= 95 || targetProgress <= 0) {
            return;
        }

        // æ£€æŸ¥è·ç¦»ä¸Šæ¬¡çœŸå®è¿›åº¦æ›´æ–°çš„æ—¶é—´
        const timeSinceLastUpdate = Date.now() - lastMicroUpdateTime;
        if (timeSinceLastUpdate < MIN_UPDATE_INTERVAL) {
            return; // å¦‚æœæœ€è¿‘æœ‰æ›´æ–°ï¼Œè·³è¿‡å¾®è¿›åº¦
        }

        // è®¡ç®—å½“å‰å¯ä»¥å¾®æ¨è¿›çš„æœ€å¤§å€¼
        // åŸºäºlastKnownProgressï¼ˆä¸Šæ¬¡çœŸå®è¿›åº¦ï¼‰+ microProgressMaxGap
        const maxMicroProgress = Math.min(lastKnownProgress + microProgressMaxGap, 95);

        // å½“å‰æ˜¾ç¤ºè¿›åº¦å¦‚æœå·²ç»æ¥è¿‘æœ€å¤§å€¼ï¼Œåœæ­¢æ¨è¿›
        if (currentDisplayProgress >= maxMicroProgress - 0.5) {
            return;
        }

        // è®¡ç®—å¾®å¢é‡ï¼ˆéå¸¸å°çš„å¢é‡ï¼Œé¿å…æ˜æ˜¾è·³åŠ¨ï¼‰
        const distanceToMax = maxMicroProgress - currentDisplayProgress;
        const dynamicIncrement = Math.min(0.3, distanceToMax * 0.02); // æ›´å°çš„å¢é‡

        if (dynamicIncrement < 0.05) {
            return; // å¢é‡å¤ªå°ï¼Œè·³è¿‡
        }

        // å¾®è°ƒæ˜¾ç¤ºè¿›åº¦ï¼ˆåªæ›´æ–°æ˜¾ç¤ºï¼Œä¸æ”¹å˜targetProgressï¼‰
        const newDisplayProgress = currentDisplayProgress + dynamicIncrement;

        // ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§é™åˆ¶ï¼Œä¸”ä¸å›é€€
        if (newDisplayProgress > currentDisplayProgress && newDisplayProgress < maxMicroProgress) {
            currentDisplayProgress = newDisplayProgress;

            const progressBar = document.getElementById('test-progress-bar');
            const progressText = document.getElementById('test-progress-text');
            if (progressBar && progressText) {
                const displayValue = Math.round(currentDisplayProgress);
                progressBar.style.width = displayValue + '%';
                progressText.textContent = displayValue + '%';
            }
        }
    }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼ˆé™ä½é¢‘ç‡é¿å…é—ªçƒï¼‰

    // æš´éœ²æ›´æ–°æ—¶é—´æˆ³çš„æ–¹æ³•ï¼Œä¾›çœŸå®è¿›åº¦æ›´æ–°æ—¶è°ƒç”¨
    window.updateMicroProgressTimestamp = function() {
        lastMicroUpdateTime = Date.now();
    };
}

// éšè—æµ‹è¯•æ‰§è¡Œå¡ç‰‡
function hideTestExecutionCard() {
    document.getElementById('test-execution-card').style.display = 'none';
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    // æ¸…ç†åˆå§‹åŒ–è¿›åº¦åŠ¨ç”»
    if (initProgressInterval) {
        clearInterval(initProgressInterval);
        initProgressInterval = null;
    }
    // ğŸ”§ æ–°å¢: æ¸…ç†å¾®è¿›åº¦åŠ¨ç”»
    if (microProgressInterval) {
        clearInterval(microProgressInterval);
        microProgressInterval = null;
    }
    // é‡ç½®åˆå§‹åŒ–å¼€å§‹æ—¶é—´
    initProgressStartTime = null;
}

// æ›´æ–°æµ‹è¯•çŠ¶æ€
function updateTestStatus(status) {
    const message = document.getElementById('test-status-message');
    const progressBar = document.getElementById('test-progress-bar');
    const progressText = document.getElementById('test-progress-text');
    const detailLeft = document.getElementById('progress-detail-left');
    const detailRight = document.getElementById('progress-detail-right');

    // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šå•†å“æµ‹è¯•
    // æ¡ä»¶ï¼šæœ‰product_resultsï¼ˆå·²å®Œæˆçš„å•†å“ï¼‰æˆ–è€…æœ‰current_productï¼ˆæ­£åœ¨æµ‹è¯•çš„å•†å“ï¼‰
    const hasProductResults = status.product_results && Object.keys(status.product_results).length > 0;
    const hasCurrentProduct = status.current_product && status.current_product.name;
    const isMultiProduct = hasProductResults || hasCurrentProduct;

    if (isMultiProduct) {
        // å¤šå•†å“æµ‹è¯•ï¼šä½¿ç”¨åŸºäºæ­¥éª¤çš„è¿›åº¦è®¡ç®—
        const progressInfo = calculateStepBasedProgress(status);

        // ä½¿ç”¨å¹³æ»‘åŠ¨ç”»æ›´æ–°è¿›åº¦æ¡
        setProgressWithAnimation(progressInfo.percentage);

        // æ›´æ–°è¯¦ç»†è¿›åº¦ä¿¡æ¯
        if (detailLeft && detailRight) {
            detailLeft.textContent = `å·²å®Œæˆ ${progressInfo.completedSteps}/${progressInfo.totalSteps} æ­¥éª¤`;
            detailRight.textContent = `å•†å“ ${progressInfo.completedProducts}/${progressInfo.totalProducts}`;
        }

        // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
        if (status.progress && status.progress.message) {
            message.textContent = status.progress.message;
        }

        // æŒ‰å•†å“åˆ†ç»„æ˜¾ç¤ºæ­¥éª¤
        updateMultiProductSteps(status);
    } else if (status.test_steps && status.test_steps.length > 0) {
        // å•å•†å“æµ‹è¯•ï¼šæ˜¾ç¤ºæ­¥éª¤åˆ—è¡¨
        const predefinedSteps = currentTestMode === 'quick' ? QUICK_TEST_STEPS : FULL_TEST_STEPS;
        const totalSteps = predefinedSteps.length;

        // åªä½¿ç”¨åç«¯è¿”å›çš„æ­¥éª¤ï¼Œè¡¥å……é¢„å®šä¹‰çš„æè¿°ä¿¡æ¯
        const displaySteps = status.test_steps.map(backendStep => {
            const predefined = predefinedSteps.find(p => p.number === backendStep.number);
            if (predefined) {
                return {
                    ...predefined,
                    ...backendStep
                };
            }
            return backendStep;
        });

        updateTestSteps(displaySteps);

        // æ ¹æ®å·²è¿”å›æ­¥éª¤è®¡ç®—è¿›åº¦
        const completedSteps = displaySteps.filter(s =>
            s.status === 'passed' || s.status === 'failed' || s.status === 'skipped'
        ).length;
        const percentage = Math.round((completedSteps / totalSteps) * 100);

        // ä½¿ç”¨å¹³æ»‘åŠ¨ç”»æ›´æ–°è¿›åº¦
        setProgressWithAnimation(percentage);

        // æ›´æ–°è¯¦ç»†è¿›åº¦ä¿¡æ¯
        if (detailLeft && detailRight) {
            detailLeft.textContent = `æ­¥éª¤ ${completedSteps}/${totalSteps}`;
            detailRight.textContent = currentTestMode === 'quick' ? 'å¿«é€Ÿæµ‹è¯•' : 'å…¨é¢æµ‹è¯•';
        }
    } else if (status.progress) {
        // åˆå§‹åŒ–é˜¶æ®µï¼šä½¿ç”¨åç«¯è¿”å›çš„è¿›åº¦
        const { current, total, message: msg } = status.progress;
        if (total > 0) {
            const percentage = Math.round((current / total) * 100);
            setProgressWithAnimation(percentage);
        }
        if (msg) {
            message.textContent = msg;
        }
    }

    // æ›´æ–°æ—¥å¿—
    if (status.logs && status.logs.length > 0) {
        updateTestLogs(status.logs);
    }

    // æ›´æ–°çŠ¶æ€
    if (status.status === 'running') {
        message.textContent = message.textContent || 'æµ‹è¯•æ­£åœ¨æ‰§è¡Œä¸­...';
    } else if (status.status === 'completed') {
        message.textContent = 'âœ“ æµ‹è¯•æ‰§è¡Œå®Œæˆ';
        // å®Œæˆæ—¶ç›´æ¥è®¾ç½®100%ï¼ˆä¸ç”¨åŠ¨ç”»ï¼‰
        targetProgress = 100;
        currentDisplayProgress = 100;
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        progressBar.classList.add('progress-bar-completed');
        document.getElementById('test-spinner').style.display = 'none';
    } else if (status.status === 'failed') {
        message.textContent = 'âœ— æµ‹è¯•æ‰§è¡Œå¤±è´¥';
        progressBar.classList.add('progress-bar-failed');
        document.getElementById('test-spinner').style.display = 'none';
    } else if (status.status === 'stopped') {
        message.textContent = 'âŠ˜ æµ‹è¯•å·²åœæ­¢';
        // åœæ­¢æ—¶æ˜¾ç¤ºç°è‰²æ¸å˜
        progressBar.style.background = 'linear-gradient(90deg, #6b7280, #9ca3af, #6b7280)';
        progressBar.style.animation = 'none';
        document.getElementById('test-spinner').style.display = 'none';
    }
}

// æ›´æ–°å¤šå•†å“æµ‹è¯•æ­¥éª¤æ˜¾ç¤ºï¼ˆæŒ‰å•†å“åˆ†ç»„ï¼‰
function updateMultiProductSteps(status) {
    const container = document.getElementById('test-steps-container');
    const stepsList = document.getElementById('test-steps-list');

    container.style.display = 'block';

    const productResults = status.product_results || {};
    const currentProduct = status.current_product;

    // æ„å»ºåˆ†ç»„HTML
    let html = '';

    // å·²å®Œæˆçš„å•†å“
    Object.entries(productResults).forEach(([productId, result]) => {
        const passedCount = result.steps.filter(s => s.status === 'passed').length;
        const failedCount = result.steps.filter(s => s.status === 'failed').length;
        const skippedCount = result.steps.filter(s => s.status === 'skipped').length;
        const totalCount = result.steps.length;
        const statusClass = failedCount > 0 ? 'border-danger' : 'border-success';
        const statusIcon = failedCount > 0 ? 'âœ—' : 'âœ“';
        const statusColor = failedCount > 0 ? 'text-danger' : 'text-success';
        const headerBg = failedCount > 0 ? 'bg-danger-subtle' : 'bg-success-subtle';
        const safeProductId = productId.replace(/[^a-zA-Z0-9]/g, '_');

        html += `
            <div class="card ${statusClass} mb-3">
                <div class="card-header ${headerBg} d-flex justify-content-between align-items-center"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#product-${safeProductId}">
                    <div>
                        <span class="${statusColor} me-2 fs-5">${statusIcon}</span>
                        <strong>${escapeHtml(result.name)}</strong>
                        <small class="text-muted ms-2">(${productId})</small>
                    </div>
                    <div>
                        <span class="badge bg-success me-1">${passedCount} é€šè¿‡</span>
                        ${failedCount > 0 ? `<span class="badge bg-danger me-1">${failedCount} å¤±è´¥</span>` : ''}
                        ${skippedCount > 0 ? `<span class="badge bg-warning me-1">${skippedCount} è·³è¿‡</span>` : ''}
                        <i class="bi bi-chevron-down ms-2"></i>
                    </div>
                </div>
                <div class="collapse" id="product-${safeProductId}">
                    <div class="card-body">
                        ${generateStepsHtml(result.steps, safeProductId + '-')}
                    </div>
                </div>
            </div>
        `;
    });

    // å½“å‰æ­£åœ¨æµ‹è¯•çš„å•†å“
    if (currentProduct && currentProduct.name) {
        const safeCurrentId = (currentProduct.id || 'current').replace(/[^a-zA-Z0-9]/g, '_');
        html += `
            <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <strong>${escapeHtml(currentProduct.name)}</strong>
                        <small class="ms-2">(${currentProduct.id || 'æµ‹è¯•ä¸­'})</small>
                    </div>
                    <span class="badge bg-light text-primary">è¿›è¡Œä¸­</span>
                </div>
                <div class="card-body">
                    ${currentProduct.steps && currentProduct.steps.length > 0
                        ? generateStepsHtml(currentProduct.steps, safeCurrentId + '-')
                        : '<div class="text-muted text-center py-2">æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•æ­¥éª¤...</div>'}
                </div>
            </div>
        `;
    }

    if (!html) {
        html = '<div class="text-muted text-center py-3"><span class="spinner-border spinner-border-sm me-2"></span>æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•...</div>';
    }

    stepsList.innerHTML = html;
}

// ç”Ÿæˆæ­¥éª¤HTMLï¼ˆç”¨äºå¤šå•†å“åˆ†ç»„ï¼Œä¸å•å•†å“æµ‹è¯•å®Œå…¨ä¸€è‡´çš„å¡ç‰‡æ ·å¼ï¼‰
function generateStepsHtml(steps, idPrefix = '') {
    if (!steps || steps.length === 0) return '<div class="text-muted">æš‚æ— æ­¥éª¤</div>';

    return steps.map(step => {
        let statusIcon = '';
        let statusClass = '';
        let statusBadge = '';

        if (step.status === 'passed') {
            statusIcon = 'âœ“';
            statusClass = 'border-success test-step-card';
            statusBadge = '<span class="badge bg-success">é€šè¿‡</span>';
        } else if (step.status === 'failed') {
            statusIcon = 'âœ—';
            statusClass = 'border-danger test-step-card';
            statusBadge = '<span class="badge bg-danger">å¤±è´¥</span>';
        } else if (step.status === 'skipped') {
            statusIcon = 'âŠ˜';
            statusClass = 'border-warning test-step-card';
            statusBadge = '<span class="badge bg-warning">è·³è¿‡</span>';
        } else if (step.status === 'running') {
            statusIcon = 'â‹¯';
            statusClass = 'border-primary test-step-card';
            statusBadge = '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm me-1"></span>è¿›è¡Œä¸­</span>';
        } else {
            statusIcon = 'â—‹';
            statusClass = 'border-secondary test-step-card';
            statusBadge = '<span class="badge bg-secondary">å¾…æ‰§è¡Œ</span>';
        }

        let durationHtml = '';
        if (step.duration !== undefined) {
            durationHtml = `<span class="step-duration ms-2">â± ${step.duration}s</span>`;
        }

        // ç”Ÿæˆé—®é¢˜è¯¦æƒ…HTMLï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        let issueDetailsHtml = '';
        if (step.issue_details) {
            const details = step.issue_details;
            const stepId = `${idPrefix}issue-${step.number}`;

            const naturalExplanation = generateNaturalExplanation(details);

            const jsErrorsHtml = details.js_errors && details.js_errors.length > 0
                ? `<div class="mt-2"><strong>JavaScripté”™è¯¯:</strong>
                     <ul class="mb-0 mt-1">
                       ${details.js_errors.slice(0, 3).map(err => `<li class="text-danger small">${escapeHtml(err)}</li>`).join('')}
                       ${details.js_errors.length > 3 ? `<li class="text-muted small">...è¿˜æœ‰ ${details.js_errors.length - 3} ä¸ªé”™è¯¯</li>` : ''}
                     </ul>
                   </div>`
                : '';

            const rootCauseHtml = formatRootCause(details.root_cause || 'N/A');

            issueDetailsHtml = `
                <div class="alert alert-danger mt-2 mb-0" style="background-color: #f8d7da; border-left: 4px solid #dc3545;">
                    <div class="d-flex align-items-start">
                        <span class="me-2">ğŸ›</span>
                        <div class="flex-grow-1">
                            <strong>å‘ç°Bug:</strong> ${escapeHtml(naturalExplanation)}
                            <div class="mt-2">
                                <a class="text-decoration-none small" data-bs-toggle="collapse" href="#${stepId}" role="button" aria-expanded="false">
                                    <i class="bi bi-chevron-down"></i> æŸ¥çœ‹è¯¦ç»†æŠ€æœ¯ä¿¡æ¯ä¸ä¿®å¤å»ºè®®
                                </a>
                            </div>
                            <div class="collapse mt-2" id="${stepId}">
                                <div class="card card-body bg-light small py-2">
                                    <div class="mb-1"><strong>ğŸ“ åœºæ™¯:</strong> ${escapeHtml(details.scenario || 'N/A')}</div>
                                    <div class="mb-1"><strong>ğŸ–±ï¸ æ“ä½œ:</strong> ${escapeHtml(details.operation || 'N/A')}</div>
                                    <div class="mb-1"><strong>âŒ é—®é¢˜:</strong> ${escapeHtml(details.problem || 'N/A')}</div>
                                    <div class="mb-2"><strong>ğŸ” æ ¹å› åˆ†æ:</strong></div>
                                    <div class="root-cause-box" style="background: #fff3cd; border-radius: 4px; padding: 10px; margin-bottom: 8px; white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.5;">${rootCauseHtml}</div>
                                    ${jsErrorsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="card ${statusClass} mb-2">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <span class="step-icon">${statusIcon}</span>
                                <strong>æ­¥éª¤ ${step.number}: ${escapeHtml(step.name)}</strong>
                                ${durationHtml}
                            </div>
                            ${step.description ? `<div class="step-description">ğŸ“ ${escapeHtml(step.description)}</div>` : ''}
                            ${step.result ? `<div class="step-result">ğŸ’¡ ${escapeHtml(step.result)}</div>` : ''}
                            ${step.error ? `<div class="step-error">âš ï¸ ${escapeHtml(step.error)}</div>` : ''}
                            ${issueDetailsHtml}
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// æ›´æ–°æµ‹è¯•æ­¥éª¤æ˜¾ç¤º
function updateTestSteps(steps) {
    const container = document.getElementById('test-steps-container');
    const stepsList = document.getElementById('test-steps-list');

    // æ˜¾ç¤ºæ­¥éª¤å®¹å™¨
    container.style.display = 'block';

    // ç”Ÿæˆæ­¥éª¤HTML
    const html = steps.map(step => {
        let statusIcon = '';
        let statusClass = '';
        let statusBadge = '';

        if (step.status === 'passed') {
            statusIcon = 'âœ“';
            statusClass = 'border-success test-step-card';
            statusBadge = '<span class="badge bg-success">é€šè¿‡</span>';
        } else if (step.status === 'failed') {
            statusIcon = 'âœ—';
            statusClass = 'border-danger test-step-card';
            statusBadge = '<span class="badge bg-danger">å¤±è´¥</span>';
        } else if (step.status === 'skipped') {
            statusIcon = 'âŠ˜';
            statusClass = 'border-warning test-step-card';
            statusBadge = '<span class="badge bg-warning">è·³è¿‡</span>';
        } else if (step.status === 'running') {
            statusIcon = 'â‹¯';
            statusClass = 'border-primary test-step-card';
            statusBadge = '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm me-1"></span>è¿›è¡Œä¸­</span>';
        } else {
            statusIcon = 'â—‹';
            statusClass = 'border-secondary test-step-card';
            statusBadge = '<span class="badge bg-secondary">å¾…æ‰§è¡Œ</span>';
        }

        let durationHtml = '';
        if (step.duration !== undefined) {
            durationHtml = `<span class="step-duration ms-2">â± ${step.duration}s</span>`;
        }

        // ç”Ÿæˆé—®é¢˜è¯¦æƒ…HTMLï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        let issueDetailsHtml = '';
        if (step.issue_details) {
            const details = step.issue_details;
            const stepId = `issue-${step.number}`;

            // ğŸ”§ æ–°å¢: ç”Ÿæˆè‡ªç„¶è¯­è¨€çš„é—®é¢˜è§£é‡Š
            const naturalExplanation = generateNaturalExplanation(details);

            const jsErrorsHtml = details.js_errors && details.js_errors.length > 0
                ? `<div class="mt-2"><strong>JavaScripté”™è¯¯:</strong>
                     <ul class="mb-0 mt-1">
                       ${details.js_errors.slice(0, 3).map(err => `<li class="text-danger small">${escapeHtml(err)}</li>`).join('')}
                       ${details.js_errors.length > 3 ? `<li class="text-muted small">...è¿˜æœ‰ ${details.js_errors.length - 3} ä¸ªé”™è¯¯</li>` : ''}
                     </ul>
                   </div>`
                : '';

            // ğŸ”§ æ”¹è¿›: æ ¹å› åˆ†ææ”¯æŒæ¢è¡Œå’Œæ ¼å¼åŒ–æ˜¾ç¤º
            const rootCauseHtml = formatRootCause(details.root_cause || 'N/A');

            issueDetailsHtml = `
                <div class="alert alert-danger mt-2 mb-0" style="background-color: #f8d7da; border-left: 4px solid #dc3545;">
                    <div class="d-flex align-items-start">
                        <span class="me-2">ğŸ›</span>
                        <div class="flex-grow-1">
                            <strong>å‘ç°Bug:</strong> ${escapeHtml(naturalExplanation)}
                            <div class="mt-2">
                                <a class="text-decoration-none small" data-bs-toggle="collapse" href="#${stepId}" role="button" aria-expanded="false">
                                    <i class="bi bi-chevron-down"></i> æŸ¥çœ‹è¯¦ç»†æŠ€æœ¯ä¿¡æ¯ä¸ä¿®å¤å»ºè®®
                                </a>
                            </div>
                            <div class="collapse mt-2" id="${stepId}">
                                <div class="card card-body bg-light small py-2">
                                    <div class="mb-1"><strong>ğŸ“ åœºæ™¯:</strong> ${escapeHtml(details.scenario || 'N/A')}</div>
                                    <div class="mb-1"><strong>ğŸ–±ï¸ æ“ä½œ:</strong> ${escapeHtml(details.operation || 'N/A')}</div>
                                    <div class="mb-1"><strong>âŒ é—®é¢˜:</strong> ${escapeHtml(details.problem || 'N/A')}</div>
                                    <div class="mb-2"><strong>ğŸ” æ ¹å› åˆ†æ:</strong></div>
                                    <div class="root-cause-box" style="background: #fff3cd; border-radius: 4px; padding: 10px; margin-bottom: 8px; white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.5;">${rootCauseHtml}</div>
                                    ${jsErrorsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="card ${statusClass}">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <span class="step-icon">${statusIcon}</span>
                                <strong>æ­¥éª¤ ${step.number}: ${escapeHtml(step.name)}</strong>
                                ${durationHtml}
                            </div>
                            ${step.description ? `<div class="step-description">ğŸ“ ${escapeHtml(step.description)}</div>` : ''}
                            ${step.result ? `<div class="step-result">ğŸ’¡ ${escapeHtml(step.result)}</div>` : ''}
                            ${step.error ? `<div class="step-error">âš ï¸ ${escapeHtml(step.error)}</div>` : ''}
                            ${issueDetailsHtml}
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    stepsList.innerHTML = html;
}

// æ›´æ–°æµ‹è¯•æ—¥å¿—
let lastLogCount = 0;
function updateTestLogs(logs) {
    const logsDiv = document.getElementById('test-output-log');

    if (logs.length > lastLogCount) {
        const newLogs = logs.slice(lastLogCount);
        const logsHtml = newLogs.map(log => {
            if (log.includes('ERROR') || log.includes('å¤±è´¥') || log.includes('âœ—')) {
                return `<div class="log-error">${escapeHtml(log)}</div>`;
            } else if (log.includes('SUCCESS') || log.includes('æˆåŠŸ') || log.includes('âœ“')) {
                return `<div class="log-success">${escapeHtml(log)}</div>`;
            } else if (log.includes('WARNING') || log.includes('è­¦å‘Š')) {
                return `<div class="log-warning">${escapeHtml(log)}</div>`;
            }
            return `<div>${escapeHtml(log)}</div>`;
        }).join('');

        if (lastLogCount === 0) {
            logsDiv.innerHTML = logsHtml;
        } else {
            logsDiv.insertAdjacentHTML('beforeend', logsHtml);
        }

        logsDiv.scrollTop = logsDiv.scrollHeight;
        lastLogCount = logs.length;
    }
}

// åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º
function toggleTestLogs() {
    const logsDiv = document.getElementById('test-output-log');
    const btn = document.getElementById('toggle-logs-btn');

    if (logsDiv.style.display === 'none') {
        logsDiv.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-chevron-up"></i> éšè—è¯¦ç»†æ—¥å¿—';
    } else {
        logsDiv.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-chevron-down"></i> æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—';
    }
}

// æµ‹è¯•å®Œæˆ
function onTestComplete(result) {
    // ğŸ”§ æ–°å¢: åœæ­¢å¾®è¿›åº¦åŠ¨ç”»
    if (microProgressInterval) {
        clearInterval(microProgressInterval);
        microProgressInterval = null;
    }

    // ğŸ”§ æ–°å¢: æ¸…é™¤ä¿å­˜çš„æµ‹è¯•çŠ¶æ€
    clearTestState();

    // å»¶è¿Ÿéšè—æ‰§è¡Œå¡ç‰‡ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæˆæ•ˆæœï¼ˆç»¿è‰²è„‰åŠ¨ï¼‰
    setTimeout(() => {
        hideTestExecutionCard();
        // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        showDetailedResults(result);
    }, 2000);

    if (result.status === 'completed' || result.status === 'failed') {
        // ğŸ”§ ä¿®å¤: ç»Ÿè®¡å¤±è´¥æ­¥éª¤æ•°æ¥åˆ¤å®šæ˜¯å¦çœŸæ­£é€šè¿‡
        const steps = result.test_steps || [];
        const failedCount = steps.filter(s => s.status === 'failed').length;

        if (failedCount > 0) {
            utils.showToast('æµ‹è¯•æ‰§è¡Œå®Œæˆï¼Œå­˜åœ¨å¤±è´¥æ­¥éª¤ï¼', 'warning');
        } else {
            utils.showToast('æµ‹è¯•æ‰§è¡Œå®Œæˆï¼', 'success');
        }
    } else {
        utils.showToast('æµ‹è¯•æ‰§è¡Œå¤±è´¥', 'error');
    }
}

// æ˜¾ç¤ºè¯¦ç»†æµ‹è¯•ç»“æœ
function showDetailedResults(result) {
    const resultsCard = document.getElementById('current-test-results');
    resultsCard.style.display = 'block';

    // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šå•†å“æµ‹è¯•ï¼ˆæœ‰product_resultsï¼‰
    const isMultiProduct = result.product_results && Object.keys(result.product_results).length > 0;

    if (isMultiProduct) {
        // å¤šå•†å“æµ‹è¯•ç»“æœæ˜¾ç¤º
        showMultiProductResults(result, resultsCard);
    } else {
        // å•å•†å“æµ‹è¯•ç»“æœæ˜¾ç¤º
        showSingleProductResults(result, resultsCard);
    }

    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// æ˜¾ç¤ºå¤šå•†å“æµ‹è¯•ç»“æœ
function showMultiProductResults(result, resultsCard) {
    const productResults = result.product_results || {};
    const productCount = Object.keys(productResults).length;

    // ç»Ÿè®¡æ‰€æœ‰å•†å“çš„æ­¥éª¤
    let totalPassed = 0, totalFailed = 0, totalSkipped = 0, totalSteps = 0;
    let productsPassed = 0, productsFailed = 0;

    Object.values(productResults).forEach(product => {
        const steps = product.steps || [];
        totalPassed += steps.filter(s => s.status === 'passed').length;
        totalFailed += steps.filter(s => s.status === 'failed').length;
        totalSkipped += steps.filter(s => s.status === 'skipped').length;
        totalSteps += steps.length;

        if (steps.some(s => s.status === 'failed')) {
            productsFailed++;
        } else {
            productsPassed++;
        }
    });

    // æ›´æ–°å¡ç‰‡å¤´éƒ¨çŠ¶æ€
    const cardHeader = resultsCard.querySelector('.card-header');
    if (totalFailed === 0) {
        cardHeader.classList.remove('bg-danger', 'bg-warning');
        cardHeader.classList.add('bg-success');
        cardHeader.querySelector('span').innerHTML = `<i class="bi bi-check-circle"></i> æµ‹è¯•å®Œæˆ - ${productCount} ä¸ªå•†å“å…¨éƒ¨é€šè¿‡`;
    } else {
        cardHeader.classList.remove('bg-success', 'bg-warning');
        cardHeader.classList.add('bg-danger');
        cardHeader.querySelector('span').innerHTML = `<i class="bi bi-x-circle"></i> æµ‹è¯•å®Œæˆ - ${productsFailed}/${productCount} ä¸ªå•†å“å­˜åœ¨å¤±è´¥`;
    }

    // æ›´æ–°æ€»ä½“ç»Ÿè®¡
    const allPassed = totalFailed === 0;
    document.getElementById('result-status-icon').textContent = allPassed ? 'âœ“' : 'âœ—';
    document.getElementById('result-status').textContent = allPassed ? 'PASSED' : 'FAILED';
    document.getElementById('result-status').className = allPassed ? 'mb-0 text-success' : 'mb-0 text-danger';

    document.getElementById('result-duration').textContent = (result.result?.duration || 0).toFixed(2) + 's';
    document.getElementById('result-passed').textContent = totalPassed;
    document.getElementById('result-total').textContent = totalSteps;
    document.getElementById('result-failed').textContent = totalFailed;

    // æ˜¾ç¤ºæŒ‰å•†å“åˆ†ç»„çš„è¯¦ç»†æ­¥éª¤
    const stepsContainer = document.getElementById('result-steps-container');
    let html = `<h6 class="mb-3">æµ‹è¯•è¯¦æƒ… (${productCount} ä¸ªå•†å“)</h6>`;

    Object.entries(productResults).forEach(([productId, product]) => {
        const steps = product.steps || [];
        const passedCount = steps.filter(s => s.status === 'passed').length;
        const failedCount = steps.filter(s => s.status === 'failed').length;
        const skippedCount = steps.filter(s => s.status === 'skipped').length;
        const statusClass = failedCount > 0 ? 'border-danger' : 'border-success';
        const statusIcon = failedCount > 0 ? 'âœ—' : 'âœ“';
        const statusColor = failedCount > 0 ? 'text-danger' : 'text-success';
        const headerBg = failedCount > 0 ? 'bg-danger-subtle' : 'bg-success-subtle';
        const safeProductId = 'result-' + productId.replace(/[^a-zA-Z0-9]/g, '_');

        html += `
            <div class="card ${statusClass} mb-3">
                <div class="card-header ${headerBg} d-flex justify-content-between align-items-center"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#${safeProductId}">
                    <div>
                        <span class="${statusColor} me-2 fs-5">${statusIcon}</span>
                        <strong>${escapeHtml(product.name)}</strong>
                        <small class="text-muted ms-2">(${productId})</small>
                    </div>
                    <div>
                        <span class="badge bg-success me-1">${passedCount} é€šè¿‡</span>
                        ${failedCount > 0 ? `<span class="badge bg-danger me-1">${failedCount} å¤±è´¥</span>` : ''}
                        ${skippedCount > 0 ? `<span class="badge bg-warning me-1">${skippedCount} è·³è¿‡</span>` : ''}
                        <i class="bi bi-chevron-down ms-2"></i>
                    </div>
                </div>
                <div class="collapse" id="${safeProductId}">
                    <div class="card-body">
                        ${generateStepsHtml(steps, safeProductId + '-')}
                    </div>
                </div>
            </div>
        `;
    });

    stepsContainer.innerHTML = html;
}

// æ˜¾ç¤ºå•å•†å“æµ‹è¯•ç»“æœ
function showSingleProductResults(result, resultsCard) {
    // åˆå¹¶é¢„å®šä¹‰æ­¥éª¤ä¸åç«¯è¿”å›çš„æ­¥éª¤ï¼Œç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½æ˜¾ç¤º
    const predefinedSteps = currentTestMode === 'quick' ? QUICK_TEST_STEPS : FULL_TEST_STEPS;
    const backendSteps = result.test_steps || [];

    // åˆå¹¶æ­¥éª¤ï¼šä»¥é¢„å®šä¹‰æ­¥éª¤ä¸ºåŸºç¡€ï¼Œç”¨åç«¯è¿”å›çš„çŠ¶æ€æ›´æ–°
    const steps = predefinedSteps.map(predefined => {
        const backendStep = backendSteps.find(s => s.number === predefined.number);
        if (backendStep) {
            return {
                ...predefined,
                ...backendStep
            };
        }
        // å¦‚æœåç«¯æ²¡æœ‰è¿”å›è¯¥æ­¥éª¤çš„ç»“æœï¼Œæ ‡è®°ä¸ºpending
        return { ...predefined, status: 'pending' };
    });

    // è·å–æ­¥éª¤ç»Ÿè®¡
    const passedCount = steps.filter(s => s.status === 'passed').length;
    const failedCount = steps.filter(s => s.status === 'failed').length;
    const totalCount = steps.length;

    // æ›´æ–°å¡ç‰‡å¤´éƒ¨çŠ¶æ€
    const cardHeader = resultsCard.querySelector('.card-header');
    if (failedCount === 0 && passedCount === totalCount) {
        cardHeader.classList.remove('bg-danger');
        cardHeader.classList.add('bg-success');
        cardHeader.querySelector('span').innerHTML = '<i class="bi bi-check-circle"></i> æµ‹è¯•å®Œæˆ - å…¨éƒ¨é€šè¿‡';
    } else if (failedCount > 0) {
        cardHeader.classList.remove('bg-success');
        cardHeader.classList.add('bg-danger');
        cardHeader.querySelector('span').innerHTML = '<i class="bi bi-x-circle"></i> æµ‹è¯•å®Œæˆ - å­˜åœ¨å¤±è´¥';
    } else {
        cardHeader.classList.remove('bg-success', 'bg-danger');
        cardHeader.classList.add('bg-warning');
        cardHeader.querySelector('span').innerHTML = '<i class="bi bi-exclamation-circle"></i> æµ‹è¯•å®Œæˆ - éƒ¨åˆ†æ­¥éª¤æœªå®Œæˆ';
    }

    // æ›´æ–°æ€»ä½“ç»Ÿè®¡
    const allPassed = failedCount === 0 && passedCount === totalCount;
    document.getElementById('result-status-icon').textContent = allPassed ? 'âœ“' : 'âœ—';
    document.getElementById('result-status').textContent = allPassed ? 'PASSED' : 'FAILED';
    document.getElementById('result-status').className = allPassed ? 'mb-0 text-success' : 'mb-0 text-danger';

    document.getElementById('result-duration').textContent = (result.result?.duration || 0).toFixed(2) + 's';
    document.getElementById('result-passed').textContent = passedCount;
    document.getElementById('result-total').textContent = totalCount;
    document.getElementById('result-failed').textContent = failedCount;

    // æ˜¾ç¤ºè¯¦ç»†æ­¥éª¤ - ä½¿ç”¨ä¸å¤šå•†å“ä¸€è‡´çš„generateStepsHtml
    const stepsContainer = document.getElementById('result-steps-container');
    if (steps.length > 0) {
        stepsContainer.innerHTML = '<h6 class="mb-3">è¯¦ç»†æ­¥éª¤</h6>' + generateStepsHtml(steps, 'result-single-');
    } else {
        stepsContainer.innerHTML = '<p class="text-muted">æ— æ­¥éª¤ä¿¡æ¯</p>';
    }
}

// æ¸…é™¤å½“å‰ç»“æœ
function clearCurrentResults() {
    document.getElementById('current-test-results').style.display = 'none';
}

// æ›´æ–°å·²ç”¨æ—¶é—´
function updateElapsedTime() {
    if (!testStartTime) return;

    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;

    document.getElementById('test-elapsed-time').textContent =
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// è¿›åº¦æ¡å¹³æ»‘æ’å€¼åŠ¨ç”»å‡½æ•° - ä½¿ç”¨CSSè¿‡æ¸¡å®ç°å®Œå…¨å¹³æ»‘
function animateProgressBar() {
    const progressBar = document.getElementById('test-progress-bar');
    const progressText = document.getElementById('test-progress-text');

    if (!progressBar || !progressText) return;

    // è®¡ç®—æ’å€¼æ­¥é•¿ï¼ˆä½¿ç”¨æ›´å°çš„æ­¥é•¿å®ç°æ›´å¹³æ»‘æ•ˆæœï¼‰
    const diff = targetProgress - currentDisplayProgress;
    // ä½¿ç”¨æ›´å°çš„æ­¥é•¿(5%)å®ç°å¹³æ»‘è¿‡æ¸¡
    const step = diff * 0.05;

    // å½“å·®å€¼è¶³å¤Ÿå°æ—¶ï¼Œç›´æ¥è®¾ç½®ä¸ºç›®æ ‡å€¼
    if (Math.abs(diff) < 0.1) {
        currentDisplayProgress = targetProgress;
    } else {
        currentDisplayProgress += step;
    }

    // ğŸ”§ ä¿®å¤: è¿›åº¦æ¡å®½åº¦å’Œæ–‡å­—æ•°å€¼ä½¿ç”¨ç›¸åŒçš„å€¼ï¼Œç¡®ä¿åŒæ­¥
    const displayValue = Math.round(currentDisplayProgress);
    progressBar.style.width = displayValue + '%';
    progressText.textContent = displayValue + '%';

    // å¦‚æœè¿˜æ²¡åˆ°è¾¾ç›®æ ‡ï¼Œç»§ç»­åŠ¨ç”»
    if (Math.abs(targetProgress - currentDisplayProgress) >= 0.1) {
        progressAnimationFrame = requestAnimationFrame(animateProgressBar);
    } else {
        progressAnimationFrame = null;
    }
}

// è®¾ç½®ç›®æ ‡è¿›åº¦å¹¶å¯åŠ¨åŠ¨ç”»
// ğŸ”§ ä¿®å¤: è¿›åº¦æ¡åªèƒ½å¾€å‰èµ°ï¼Œä¸èƒ½å›é€€
// ğŸ”§ ä¿®å¤v3.1.0: åŒæ­¥æ›´æ–°å¾®è¿›åº¦æ—¶é—´æˆ³ï¼Œé¿å…é—ªçƒ
function setProgressWithAnimation(percentage, forceUpdate = false) {
    const newTarget = Math.min(100, Math.max(0, percentage));

    // æ ¸å¿ƒä¿®å¤: åªæœ‰æ–°è¿›åº¦ > å½“å‰ç›®æ ‡è¿›åº¦æ—¶æ‰æ›´æ–°ï¼ˆç¡®ä¿åªè¿›ä¸é€€ï¼‰
    // forceUpdate ç”¨äºç‰¹æ®Šæƒ…å†µï¼ˆå¦‚é‡ç½®è¿›åº¦æ¡ï¼‰
    if (!forceUpdate && newTarget <= targetProgress) {
        return; // å¿½ç•¥å›é€€è¯·æ±‚
    }

    // ğŸ”§ v3.1.0: æ›´æ–°å¾®è¿›åº¦æ—¶é—´æˆ³ï¼Œé¿å…å¾®è¿›åº¦å’ŒçœŸå®è¿›åº¦å†²çª
    if (window.updateMicroProgressTimestamp) {
        window.updateMicroProgressTimestamp();
    }

    targetProgress = newTarget;

    // ğŸ”§ æ–°å¢: æ›´æ–°lastKnownProgressç”¨äºå¾®è¿›åº¦åŠ¨ç”»çš„è¾¹ç•Œè®¡ç®—
    // å½“æ”¶åˆ°æ–°çš„çœŸå®è¿›åº¦æ—¶ï¼Œæ›´æ–°lastKnownProgress
    lastKnownProgress = newTarget;

    // ğŸ”§ v3.1.0: å¦‚æœçœŸå®è¿›åº¦è¶…è¿‡äº†å½“å‰æ˜¾ç¤ºè¿›åº¦ï¼ŒåŒæ­¥æ›´æ–°æ˜¾ç¤ºè¿›åº¦
    // è¿™ç¡®ä¿è¿›åº¦åªä¼šå¾€å‰èµ°
    if (newTarget > currentDisplayProgress) {
        // ä¸ç›´æ¥è·³å˜ï¼Œè®©åŠ¨ç”»å»è¿½èµ¶
    }

    // å¦‚æœåŠ¨ç”»æœªè¿è¡Œï¼Œå¯åŠ¨åŠ¨ç”»
    if (!progressAnimationFrame) {
        progressAnimationFrame = requestAnimationFrame(animateProgressBar);
    }
}

// è®¡ç®—åŸºäºæ­¥éª¤çš„è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆå¤šå•†å“æµ‹è¯•ï¼‰
function calculateStepBasedProgress(status) {
    const productResults = status.product_results || {};
    const currentProduct = status.current_product;
    const stepsPerProduct = currentTestMode === 'quick' ? 5 : 12;

    // è®¡ç®—å·²å®Œæˆå•†å“çš„æ­¥éª¤æ•°
    let completedSteps = 0;
    Object.values(productResults).forEach(result => {
        if (result.steps) {
            completedSteps += result.steps.filter(s =>
                s.status === 'passed' || s.status === 'failed' || s.status === 'skipped'
            ).length;
        }
    });

    // åŠ ä¸Šå½“å‰æ­£åœ¨æµ‹è¯•å•†å“çš„å·²å®Œæˆæ­¥éª¤
    if (currentProduct && currentProduct.steps) {
        completedSteps += currentProduct.steps.filter(s =>
            s.status === 'passed' || s.status === 'failed' || s.status === 'skipped'
        ).length;
    }

    // è®¡ç®—æ€»æ­¥éª¤æ•°
    // å¦‚æœçŸ¥é“æ€»å•†å“æ•°ï¼Œç”¨æ€»å•†å“æ•° * æ¯å•†å“æ­¥éª¤æ•°
    // å¦åˆ™ç”¨å·²çŸ¥å•†å“æ•°ä¼°ç®—
    let knownProducts = Object.keys(productResults).length;
    if (currentProduct && currentProduct.name) {
        knownProducts += 1;
    }

    // å°è¯•ä»progressä¸­è·å–æ€»å•†å“æ•°
    if (status.progress && status.progress.total > 0) {
        totalExpectedProducts = status.progress.total;
        totalExpectedSteps = totalExpectedProducts * stepsPerProduct;
    } else if (totalExpectedProducts > 0) {
        // ä½¿ç”¨ä¹‹å‰è®°å½•çš„å€¼
        totalExpectedSteps = totalExpectedProducts * stepsPerProduct;
    } else if (knownProducts > 0) {
        // å›é€€ï¼šä½¿ç”¨å·²çŸ¥å•†å“æ•°ä¼°ç®—
        totalExpectedSteps = Math.max(knownProducts * stepsPerProduct, completedSteps + stepsPerProduct);
    } else {
        totalExpectedSteps = stepsPerProduct; // æœ€å°å€¼
    }

    // è®¡ç®—ç™¾åˆ†æ¯”
    const percentage = totalExpectedSteps > 0
        ? Math.round((completedSteps / totalExpectedSteps) * 100)
        : 0;

    return {
        percentage: Math.min(percentage, 99), // ä¸è¶…è¿‡99%ï¼Œç•™ç»™å®ŒæˆçŠ¶æ€
        completedSteps,
        totalSteps: totalExpectedSteps,
        completedProducts: Object.keys(productResults).length,
        totalProducts: totalExpectedProducts || knownProducts
    };
}

// ğŸ”§ æ ¼å¼åŒ–æ ¹å› åˆ†æå†…å®¹ï¼Œæ”¯æŒæ¢è¡Œå’Œç‰¹æ®Šæ ‡è®°
function formatRootCause(rootCause) {
    if (!rootCause) return 'N/A';

    // å…ˆè½¬ä¹‰HTML
    let html = escapeHtml(rootCause);

    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
    html = html.replace(/\n/g, '<br>');

    // é«˜äº®ã€xxxã€‘æ ‡è®°
    html = html.replace(/ã€([^ã€‘]+)ã€‘/g, '<strong style="color: #d63384;">ã€$1ã€‘</strong>');

    // é«˜äº® â€¢ åˆ—è¡¨é¡¹
    html = html.replace(/â€¢/g, '<span style="color: var(--color-accent);">â€¢</span>');

    return html;
}

// ğŸ”§ ç”Ÿæˆè‡ªç„¶è¯­è¨€çš„é—®é¢˜è§£é‡Šï¼ˆåŒ…å«å…·ä½“çš„ç½‘é¡µã€æ“ä½œã€é—®é¢˜æè¿°ï¼‰
function generateNaturalExplanation(details) {
    if (!details) return 'æœªçŸ¥é—®é¢˜';

    const scenario = details.scenario || '';
    const operation = details.operation || '';
    const problem = details.problem || '';
    const root_cause = details.root_cause || '';

    // æ„å»ºå…·ä½“çš„æè¿°
    let explanation = '';

    // 1. åœ¨å“ªä¸ªç½‘é¡µ
    let pageInfo = '';
    if (scenario.includes('è´­ç‰©è½¦')) {
        pageInfo = 'åœ¨è´­ç‰©è½¦é¡µé¢ï¼ˆfiido.com/cartï¼‰';
    } else if (scenario.includes('å•†å“')) {
        pageInfo = 'åœ¨å•†å“è¯¦æƒ…é¡µ';
    } else if (scenario.includes('æ”¯ä»˜') || scenario.includes('Checkout')) {
        pageInfo = 'åœ¨æ”¯ä»˜æµç¨‹ä¸­';
    }

    // 2. æ‰§è¡Œä»€ä¹ˆæ“ä½œ
    let actionInfo = '';
    if (operation.includes('åŠ å·') || operation.includes('å¢åŠ ')) {
        actionInfo = 'ç‚¹å‡»å•†å“æ•°é‡"+"æŒ‰é’®';
    } else if (operation.includes('å‡å·') || operation.includes('å‡å°‘')) {
        actionInfo = 'ç‚¹å‡»å•†å“æ•°é‡"-"æŒ‰é’®';
    } else if (operation.includes('Checkout') || operation.includes('æ”¯ä»˜')) {
        actionInfo = 'ç‚¹å‡»ç»“è´¦æŒ‰é’®';
    } else if (operation) {
        actionInfo = operation;
    }

    // 3. å‡ºç°ä»€ä¹ˆé—®é¢˜
    let problemInfo = '';
    if (problem.includes('æ•°é‡æœªå‘ç”Ÿå˜åŒ–')) {
        problemInfo = 'å•†å“æ•°é‡æ²¡æœ‰å˜åŒ–ï¼ŒæŒ‰é’®ç‚¹å‡»æ— æ•ˆ';
    } else if (problem.includes('JavaScripté”™è¯¯')) {
        problemInfo = 'é¡µé¢å‡ºç°JavaScripté”™è¯¯';
    } else if (problem) {
        problemInfo = problem;
    }

    // ç»„åˆæˆå®Œæ•´çš„æè¿°
    if (pageInfo && actionInfo && problemInfo) {
        explanation = `${pageInfo}ï¼Œç”¨æˆ·${actionInfo}æ—¶ï¼Œ${problemInfo}ã€‚`;
    } else if (scenario && problem) {
        explanation = `${scenario}æ—¶ï¼Œ${problem}ã€‚`;
    } else if (problem) {
        explanation = problem;
    } else {
        explanation = 'æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°å¼‚å¸¸ã€‚';
    }

    // æ·»åŠ å½±å“è¯´æ˜
    if (root_cause.includes('è´­ç‰©è½¦') || scenario.includes('è´­ç‰©è½¦')) {
        explanation += ' è¿™ä¼šå½±å“ç”¨æˆ·ä¿®æ”¹è´­ä¹°æ•°é‡çš„æ“ä½œã€‚';
    } else if (root_cause.includes('Checkout') || scenario.includes('æ”¯ä»˜')) {
        explanation += ' è¿™æ˜¯é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´ç”¨æˆ·æ— æ³•å®Œæˆè´­ä¹°ã€‚';
    }

    return explanation;
}
</script>
{% endblock %}
