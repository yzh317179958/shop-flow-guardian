{% extends "base.html" %}

{% block title %}æµ‹è¯•æ‰§è¡Œ - Fiido æµ‹è¯•å·¥ä½œå°{% endblock %}

{% block extra_css %}
<style>
/* å•†å“æœç´¢æ¡†æ ·å¼ */
#test-product-search {
    border: 2px solid #dee2e6;
    transition: border-color 0.15s ease-in-out;
}

#test-product-search:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

#test-product {
    max-height: 200px;
    overflow-y: auto;
    border: 2px solid #0d6efd;
    background-color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#test-product option {
    padding: 8px 12px;
    cursor: pointer;
}

#test-product option:hover {
    background-color: #e9ecef;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="bi bi-play-circle"></i> æµ‹è¯•æ‰§è¡Œ
        </h2>
        <p class="text-muted">é…ç½®å’Œè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•</p>
    </div>
</div>

<!-- æµ‹è¯•é…ç½® -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> æµ‹è¯•é…ç½®
            </div>
            <div class="card-body">
                <form id="test-config-form">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">æµ‹è¯•èŒƒå›´</label>
                            <select class="form-select" id="test-scope" onchange="updateTestScope()">
                                <option value="all">æ‰€æœ‰å•†å“</option>
                                <option value="priority">æŒ‰ä¼˜å…ˆçº§</option>
                                <option value="category">æŒ‰åˆ†ç±»</option>
                                <option value="product">å•ä¸ªå•†å“</option>
                            </select>
                        </div>

                        <div class="col-md-6" id="priority-select" style="display: none;">
                            <label class="form-label">ä¼˜å…ˆçº§</label>
                            <select class="form-select" id="test-priority">
                                <option value="P0">P0 - æ ¸å¿ƒå•†å“</option>
                                <option value="P1">P1 - é‡è¦å•†å“</option>
                                <option value="P2">P2 - æ™®é€šå•†å“</option>
                            </select>
                        </div>

                        <div class="col-md-6" id="category-select" style="display: none;">
                            <label class="form-label">åˆ†ç±»</label>
                            <select class="form-select" id="test-category">
                                <option value="">é€‰æ‹©åˆ†ç±»...</option>
                            </select>
                        </div>

                        <div class="col-md-6" id="product-select" style="display: none;">
                            <label class="form-label">å•†å“ (æ”¯æŒæœç´¢)</label>
                            <div style="position: relative;">
                                <input type="text"
                                       class="form-control"
                                       id="test-product-search"
                                       placeholder="è¾“å…¥å•†å“åç§°æˆ–IDæœç´¢..."
                                       autocomplete="off">
                                <select class="form-select"
                                        id="test-product"
                                        size="5"
                                        style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; margin-top: 2px;">
                                </select>
                            </div>
                            <input type="hidden" id="test-product-id">
                        </div>

                    </div>

                    <!-- æµ‹è¯•æ¨¡å¼æŒ‰é’® -->
                    <div class="mt-4">
                        <h6 class="mb-3">é€‰æ‹©æµ‹è¯•æ¨¡å¼</h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-success btn-lg w-100" onclick="runTestWithMode('quick')">
                                    <i class="bi bi-lightning-charge"></i> âš¡ å¿«é€Ÿæµ‹è¯•
                                    <small class="d-block mt-1" style="font-size: 0.75rem; opacity: 0.9;">æ ¸å¿ƒè´­ç‰©æµç¨‹ï¼ˆ5æ­¥ï¼Œ15-20ç§’ï¼‰</small>
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-primary btn-lg w-100" onclick="runTestWithMode('full')">
                                    <i class="bi bi-search"></i> ğŸ” å…¨é¢æµ‹è¯•
                                    <small class="d-block mt-1" style="font-size: 0.75rem; opacity: 0.9;">å…¨é“¾è·¯åœºæ™¯è¦†ç›–ï¼ˆ12æ­¥ï¼Œ40-60ç§’ï¼‰</small>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="resetConfig()">
                            <i class="bi bi-arrow-clockwise"></i> é‡ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æµ‹è¯•æ‰§è¡ŒçŠ¶æ€ -->
<div class="card mb-4" id="test-execution-card" style="display: none;">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-gear"></i> æµ‹è¯•æ‰§è¡Œä¸­</span>
            <span class="badge bg-light text-dark" id="test-elapsed-time">00:00</span>
        </div>
    </div>
    <div class="card-body">
        <!-- æ€»ä½“è¿›åº¦ -->
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="test-status-message">æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...</span>
                <span class="spinner-border spinner-border-sm text-primary" id="test-spinner"></span>
            </div>
            <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     id="test-progress-bar"
                     role="progressbar" style="width: 0%">
                    <span id="test-progress-text">0%</span>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æµ‹è¯•æ­¥éª¤ -->
        <div id="test-steps-container" style="display: none;">
            <h6 class="mb-3">æµ‹è¯•æ­¥éª¤è¯¦æƒ…</h6>
            <div id="test-steps-list">
                <!-- æ­¥éª¤åˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- æ—¥å¿—è¾“å‡ºï¼ˆå¯é€‰å±•å¼€ï¼‰ -->
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleTestLogs()" id="toggle-logs-btn">
                <i class="bi bi-chevron-down"></i> æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
            </button>
            <div id="test-output-log" class="log-output mt-2" style="display: none; max-height: 300px;">
                <!-- å®æ—¶æ—¥å¿—è¾“å‡º -->
            </div>
        </div>
    </div>
</div>

<!-- å½“å‰æµ‹è¯•ç»“æœ -->
<div class="card" id="current-test-results" style="display: none;">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-check-circle"></i> æµ‹è¯•å®Œæˆ</span>
        <button class="btn btn-sm btn-light" onclick="clearCurrentResults()">
            <i class="bi bi-x"></i> æ¸…é™¤
        </button>
    </div>
    <div class="card-body">
        <!-- æ€»ä½“ç»“æœ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1" id="result-status-icon">âœ“</h3>
                    <p class="text-muted small mb-0">çŠ¶æ€</p>
                    <h5 class="mb-0" id="result-status">PASSED</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">â±ï¸</h3>
                    <p class="text-muted small mb-0">æ€»è€—æ—¶</p>
                    <h5 class="mb-0" id="result-duration">0.00s</h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">âœ“</h3>
                    <p class="text-muted small mb-0">é€šè¿‡æ­¥éª¤</p>
                    <h5 class="mb-0"><span id="result-passed">0</span>/<span id="result-total">0</span></h5>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h3 class="mb-1">âœ—</h3>
                    <p class="text-muted small mb-0">å¤±è´¥æ­¥éª¤</p>
                    <h5 class="mb-0 text-danger" id="result-failed">0</h5>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æ­¥éª¤ -->
        <div id="result-steps-container"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let products = [];
let currentTaskId = null;
let testStartTime = null;
let timerInterval = null;

// ğŸ”§ æ–°å¢: æµ‹è¯•æ­¥éª¤é¢„å®šä¹‰ï¼ˆä¸åç«¯scripts/run_product_test.pyä¿æŒä¸€è‡´ï¼‰
const QUICK_TEST_STEPS = [
    { number: 1, name: "é¡µé¢è®¿é—®", description: "è®¿é—®å•†å“é¡µé¢å¹¶æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£å¸¸åŠ è½½" },
    { number: 2, name: "å•†å“ä¿¡æ¯æ˜¾ç¤º", description: "éªŒè¯å•†å“æ ‡é¢˜ã€ä»·æ ¼ç­‰æ ¸å¿ƒä¿¡æ¯æ˜¯å¦æ­£ç¡®æ˜¾ç¤º" },
    { number: 3, name: "æ·»åŠ è´­ç‰©è½¦", description: "ç‚¹å‡»æ·»åŠ è´­ç‰©è½¦æŒ‰é’®ï¼ŒéªŒè¯èƒ½å¦æˆåŠŸåŠ å…¥" },
    { number: 4, name: "è´­ç‰©è½¦éªŒè¯", description: "æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦æœ‰æ–°å¢å•†å“" },
    { number: 5, name: "æ”¯ä»˜æµç¨‹", description: "è®¿é—®è´­ç‰©è½¦é¡µé¢ï¼ŒéªŒè¯CheckoutæŒ‰é’®æ˜¯å¦å¯ç”¨" }
];

const FULL_TEST_STEPS = [
    { number: 1, name: "é¡µé¢è®¿é—®", description: "è®¿é—®å•†å“é¡µé¢å¹¶ç­‰å¾…å®Œå…¨åŠ è½½" },
    { number: 2, name: "é¡µé¢ç»“æ„æ£€æµ‹", description: "æ£€æŸ¥é¡µé¢åŸºç¡€DOMç»“æ„æ˜¯å¦å®Œæ•´" },
    { number: 3, name: "å•†å“æ ‡é¢˜éªŒè¯", description: "éªŒè¯å•†å“æ ‡é¢˜æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®" },
    { number: 4, name: "ä»·æ ¼ä¿¡æ¯éªŒè¯", description: "æ£€æŸ¥å•†å“ä»·æ ¼æ˜¾ç¤ºæ˜¯å¦å®Œæ•´" },
    { number: 5, name: "å•†å“å›¾ç‰‡éªŒè¯", description: "éªŒè¯å•†å“å›¾ç‰‡æ˜¯å¦åŠ è½½æˆåŠŸ" },
    { number: 6, name: "å•†å“æè¿°éªŒè¯", description: "æ£€æŸ¥å•†å“æè¿°å†…å®¹æ˜¯å¦å­˜åœ¨" },
    { number: 7, name: "å˜ä½“é€‰æ‹©æµ‹è¯•", description: "æµ‹è¯•é¢œè‰²/å°ºå¯¸ç­‰å˜ä½“é€‰é¡¹åŠŸèƒ½" },
    { number: 8, name: "æ•°é‡é€‰æ‹©æµ‹è¯•", description: "æµ‹è¯•å•†å“æ•°é‡å¢å‡åŠŸèƒ½" },
    { number: 9, name: "æ·»åŠ è´­ç‰©è½¦", description: "æµ‹è¯•æ·»åŠ è´­ç‰©è½¦åŠŸèƒ½" },
    { number: 10, name: "è´­ç‰©è½¦éªŒè¯", description: "éªŒè¯è´­ç‰©è½¦å•†å“æ•°é‡å˜åŒ–" },
    { number: 11, name: "ç›¸å…³æ¨èéªŒè¯", description: "æ£€æŸ¥ç›¸å…³å•†å“æ¨èæ˜¯å¦æ˜¾ç¤º" },
    { number: 12, name: "æ”¯ä»˜æµç¨‹éªŒè¯", description: "éªŒè¯ä»è´­ç‰©è½¦åˆ°æ”¯ä»˜é¡µé¢çš„å®Œæ•´æµç¨‹" }
];

// å½“å‰æµ‹è¯•æ¨¡å¼
let currentTestMode = null;

// é¡µé¢åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
});

// åŠ è½½å•†å“åˆ—è¡¨
async function loadProducts() {
    try {
        const response = await fetch('/api/products/list');
        const data = await response.json();
        products = data.products || [];

        // å¡«å……åˆ†ç±»é€‰æ‹©å™¨
        const categories = [...new Set(products.map(p => p.category).filter(c => c))];
        const categorySelect = document.getElementById('test-category');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

        // è®¾ç½®å•†å“æœç´¢åŠŸèƒ½
        setupProductSearch();
    } catch (error) {
        console.error('åŠ è½½å•†å“å¤±è´¥:', error);
    }
}

// è®¾ç½®å•†å“æœç´¢åŠŸèƒ½
function setupProductSearch() {
    const searchInput = document.getElementById('test-product-search');
    const productSelect = document.getElementById('test-product');
    const productIdInput = document.getElementById('test-product-id');

    // ç›‘å¬æœç´¢è¾“å…¥
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();

        // æ¸…ç©ºä¹‹å‰çš„é€‰é¡¹
        productSelect.innerHTML = '';

        if (!searchTerm) {
            productSelect.style.display = 'none';
            productIdInput.value = '';
            return;
        }

        // è¿‡æ»¤å•†å“
        const filteredProducts = products.filter(p => {
            const nameMatch = p.name.toLowerCase().includes(searchTerm);
            const idMatch = p.id.toLowerCase().includes(searchTerm);
            return nameMatch || idMatch;
        });

        // é™åˆ¶æ˜¾ç¤ºæœ€å¤š20ä¸ªç»“æœ
        const displayProducts = filteredProducts.slice(0, 20);

        if (displayProducts.length > 0) {
            displayProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.id})`;
                option.dataset.name = product.name;
                productSelect.appendChild(option);
            });
            productSelect.style.display = 'block';

            // å¦‚æœåªæœ‰ä¸€ä¸ªå®Œå…¨åŒ¹é…çš„ç»“æœï¼Œè‡ªåŠ¨é€‰ä¸­
            if (displayProducts.length === 1 ||
                displayProducts.some(p => p.id.toLowerCase() === searchTerm)) {
                const exactMatch = displayProducts.find(p => p.id.toLowerCase() === searchTerm);
                if (exactMatch) {
                    productSelect.value = exactMatch.id;
                    productIdInput.value = exactMatch.id;
                    searchInput.value = exactMatch.name;
                }
            }
        } else {
            productSelect.style.display = 'none';
            productIdInput.value = '';
        }
    });

    // ç›‘å¬é€‰æ‹©åˆ—è¡¨çš„ç‚¹å‡»
    productSelect.addEventListener('change', function(e) {
        const selectedId = e.target.value;
        const selectedProduct = products.find(p => p.id === selectedId);

        if (selectedProduct) {
            productIdInput.value = selectedId;
            searchInput.value = selectedProduct.name;
            productSelect.style.display = 'none';
        }
    });

    // ç‚¹å‡»é€‰é¡¹æ—¶ä¹Ÿè§¦å‘é€‰æ‹©
    productSelect.addEventListener('click', function(e) {
        if (productSelect.value) {
            const selectedProduct = products.find(p => p.id === productSelect.value);
            if (selectedProduct) {
                productIdInput.value = selectedProduct.id;
                searchInput.value = selectedProduct.name;
                productSelect.style.display = 'none';
            }
        }
    });

    // ç‚¹å‡»å¤–éƒ¨æ—¶éšè—ä¸‹æ‹‰åˆ—è¡¨
    document.addEventListener('click', function(e) {
        if (e.target !== searchInput && e.target !== productSelect) {
            productSelect.style.display = 'none';
        }
    });
}

// æ›´æ–°æµ‹è¯•èŒƒå›´
function updateTestScope() {
    const scope = document.getElementById('test-scope').value;

    document.getElementById('priority-select').style.display = 'none';
    document.getElementById('category-select').style.display = 'none';
    document.getElementById('product-select').style.display = 'none';

    if (scope === 'priority') {
        document.getElementById('priority-select').style.display = 'block';
    } else if (scope === 'category') {
        document.getElementById('category-select').style.display = 'block';
    } else if (scope === 'product') {
        document.getElementById('product-select').style.display = 'block';
    }
}

// é‡ç½®é…ç½®
function resetConfig() {
    document.getElementById('test-scope').value = 'all';
    updateTestScope();
}

// ä½¿ç”¨æŒ‡å®šæ¨¡å¼è¿è¡Œæµ‹è¯•
async function runTestWithMode(mode) {
    const scope = document.getElementById('test-scope').value;
    const params = { test_mode: mode };

    // ğŸ”§ æ–°å¢: è®°å½•å½“å‰æµ‹è¯•æ¨¡å¼ï¼Œç”¨äºé¢„æ˜¾ç¤ºæ­¥éª¤
    currentTestMode = mode;

    if (scope === 'priority') {
        params.priority = document.getElementById('test-priority').value;
    } else if (scope === 'category') {
        const category = document.getElementById('test-category').value;
        if (!category) {
            utils.showToast('è¯·é€‰æ‹©åˆ†ç±»', 'warning');
            return;
        }
        params.category = category;
    } else if (scope === 'product') {
        const productId = document.getElementById('test-product-id').value;
        if (!productId) {
            utils.showToast('è¯·è¾“å…¥æˆ–é€‰æ‹©å•†å“', 'warning');
            return;
        }
        params.product_id = productId;
    }
    // scope === 'all' æ—¶ params åªåŒ…å« test_mode

    startTestExecution(params);
}

// åˆ é™¤æ—§çš„runQuickTestå‡½æ•°

// å¼€å§‹æµ‹è¯•æ‰§è¡Œ
async function startTestExecution(params) {
    try {
        const response = await fetch('/api/tests/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        });

        const data = await response.json();
        currentTaskId = data.task_id;

        // æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€å¡ç‰‡
        showTestExecutionCard();

        // å¼€å§‹è½®è¯¢çŠ¶æ€
        utils.pollTaskStatus(currentTaskId, updateTestStatus, onTestComplete);

    } catch (error) {
        utils.showToast('å¯åŠ¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
    }
}

// æ˜¾ç¤ºæµ‹è¯•æ‰§è¡Œå¡ç‰‡
function showTestExecutionCard() {
    const card = document.getElementById('test-execution-card');
    card.style.display = 'block';

    testStartTime = Date.now();
    updateElapsedTime();
    timerInterval = setInterval(updateElapsedTime, 1000);

    // ğŸ”§ ä¿®æ”¹: ä¸é¢„å…ˆæ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤ï¼Œåªæ˜¾ç¤ºç©ºçš„æ­¥éª¤å®¹å™¨
    // æ­¥éª¤å°†åœ¨æ‰§è¡Œæ—¶é€æ­¥æ˜¾ç¤º
    const container = document.getElementById('test-steps-container');
    const stepsList = document.getElementById('test-steps-list');
    container.style.display = 'block';
    stepsList.innerHTML = '<div class="text-muted text-center py-3"><span class="spinner-border spinner-border-sm me-2"></span>æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•...</div>';

    // æ»šåŠ¨åˆ°æ‰§è¡Œå¡ç‰‡
    card.scrollIntoView({ behavior: 'smooth' });
}

// éšè—æµ‹è¯•æ‰§è¡Œå¡ç‰‡
function hideTestExecutionCard() {
    document.getElementById('test-execution-card').style.display = 'none';
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// æ›´æ–°æµ‹è¯•çŠ¶æ€
function updateTestStatus(status) {
    const message = document.getElementById('test-status-message');
    const progressBar = document.getElementById('test-progress-bar');
    const progressText = document.getElementById('test-progress-text');

    // æ›´æ–°è¿›åº¦æ¡
    if (status.progress) {
        const { current, total, message: msg } = status.progress;
        if (total > 0) {
            const percentage = Math.round((current / total) * 100);
            progressBar.style.width = percentage + '%';
            progressText.textContent = percentage + '%';
        }
        if (msg) {
            message.textContent = msg;
        }
    }

    // ğŸ”§ æ”¹è¿›: åªæ˜¾ç¤ºåç«¯è¿”å›çš„å·²æ‰§è¡Œæ­¥éª¤ï¼ˆæ‰§è¡Œä¸€æ­¥æ˜¾ç¤ºä¸€æ­¥ï¼‰
    // ä¸å†é¢„æ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤ï¼Œæå‡äº¤äº’æ„Ÿ
    if (status.test_steps && status.test_steps.length > 0) {
        const predefinedSteps = currentTestMode === 'quick' ? QUICK_TEST_STEPS : FULL_TEST_STEPS;
        const totalSteps = predefinedSteps.length;

        // åªä½¿ç”¨åç«¯è¿”å›çš„æ­¥éª¤ï¼Œè¡¥å……é¢„å®šä¹‰çš„æè¿°ä¿¡æ¯
        const displaySteps = status.test_steps.map(backendStep => {
            const predefined = predefinedSteps.find(p => p.number === backendStep.number);
            if (predefined) {
                return {
                    ...predefined,
                    ...backendStep
                };
            }
            return backendStep;
        });

        updateTestSteps(displaySteps);

        // æ ¹æ®å·²è¿”å›æ­¥éª¤è®¡ç®—è¿›åº¦
        const completedSteps = displaySteps.filter(s =>
            s.status === 'passed' || s.status === 'failed' || s.status === 'skipped'
        ).length;
        const percentage = Math.round((completedSteps / totalSteps) * 100);
        progressBar.style.width = percentage + '%';
        progressText.textContent = percentage + '%';
    }

    // æ›´æ–°æ—¥å¿—
    if (status.logs && status.logs.length > 0) {
        updateTestLogs(status.logs);
    }

    // æ›´æ–°çŠ¶æ€
    if (status.status === 'running') {
        message.textContent = message.textContent || 'æµ‹è¯•æ­£åœ¨æ‰§è¡Œä¸­...';
    } else if (status.status === 'completed') {
        message.textContent = 'âœ“ æµ‹è¯•æ‰§è¡Œå®Œæˆ';
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        document.getElementById('test-spinner').style.display = 'none';
    } else if (status.status === 'failed') {
        message.textContent = 'âœ— æµ‹è¯•æ‰§è¡Œå¤±è´¥';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
        document.getElementById('test-spinner').style.display = 'none';
    }
}

// æ›´æ–°æµ‹è¯•æ­¥éª¤æ˜¾ç¤º
function updateTestSteps(steps) {
    const container = document.getElementById('test-steps-container');
    const stepsList = document.getElementById('test-steps-list');

    // æ˜¾ç¤ºæ­¥éª¤å®¹å™¨
    container.style.display = 'block';

    // ç”Ÿæˆæ­¥éª¤HTML
    const html = steps.map(step => {
        let statusIcon = '';
        let statusClass = '';
        let statusBadge = '';

        if (step.status === 'passed') {
            statusIcon = 'âœ“';
            statusClass = 'border-success test-step-card';
            statusBadge = '<span class="badge bg-success">é€šè¿‡</span>';
        } else if (step.status === 'failed') {
            statusIcon = 'âœ—';
            statusClass = 'border-danger test-step-card';
            statusBadge = '<span class="badge bg-danger">å¤±è´¥</span>';
        } else if (step.status === 'skipped') {
            statusIcon = 'âŠ˜';
            statusClass = 'border-warning test-step-card';
            statusBadge = '<span class="badge bg-warning">è·³è¿‡</span>';
        } else if (step.status === 'running') {
            statusIcon = 'â‹¯';
            statusClass = 'border-primary test-step-card';
            statusBadge = '<span class="badge bg-primary"><span class="spinner-border spinner-border-sm me-1"></span>è¿›è¡Œä¸­</span>';
        } else {
            statusIcon = 'â—‹';
            statusClass = 'border-secondary test-step-card';
            statusBadge = '<span class="badge bg-secondary">å¾…æ‰§è¡Œ</span>';
        }

        let durationHtml = '';
        if (step.duration !== undefined) {
            durationHtml = `<span class="step-duration ms-2">â± ${step.duration}s</span>`;
        }

        // ç”Ÿæˆé—®é¢˜è¯¦æƒ…HTMLï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        let issueDetailsHtml = '';
        if (step.issue_details) {
            const details = step.issue_details;
            const stepId = `issue-${step.number}`;

            // ğŸ”§ æ–°å¢: ç”Ÿæˆè‡ªç„¶è¯­è¨€çš„é—®é¢˜è§£é‡Š
            const naturalExplanation = generateNaturalExplanation(details);

            const jsErrorsHtml = details.js_errors && details.js_errors.length > 0
                ? `<div class="mt-2"><strong>JavaScripté”™è¯¯:</strong>
                     <ul class="mb-0 mt-1">
                       ${details.js_errors.slice(0, 3).map(err => `<li class="text-danger small">${escapeHtml(err)}</li>`).join('')}
                       ${details.js_errors.length > 3 ? `<li class="text-muted small">...è¿˜æœ‰ ${details.js_errors.length - 3} ä¸ªé”™è¯¯</li>` : ''}
                     </ul>
                   </div>`
                : '';

            // ğŸ”§ æ”¹è¿›: æ ¹å› åˆ†ææ”¯æŒæ¢è¡Œå’Œæ ¼å¼åŒ–æ˜¾ç¤º
            const rootCauseHtml = formatRootCause(details.root_cause || 'N/A');

            issueDetailsHtml = `
                <div class="alert alert-danger mt-2 mb-0" style="background-color: #f8d7da; border-left: 4px solid #dc3545;">
                    <div class="d-flex align-items-start">
                        <span class="me-2">ğŸ›</span>
                        <div class="flex-grow-1">
                            <strong>å‘ç°Bug:</strong> ${escapeHtml(naturalExplanation)}
                            <div class="mt-2">
                                <a class="text-decoration-none small" data-bs-toggle="collapse" href="#${stepId}" role="button" aria-expanded="false">
                                    <i class="bi bi-chevron-down"></i> æŸ¥çœ‹è¯¦ç»†æŠ€æœ¯ä¿¡æ¯ä¸ä¿®å¤å»ºè®®
                                </a>
                            </div>
                            <div class="collapse mt-2" id="${stepId}">
                                <div class="card card-body bg-light small py-2">
                                    <div class="mb-1"><strong>ğŸ“ åœºæ™¯:</strong> ${escapeHtml(details.scenario || 'N/A')}</div>
                                    <div class="mb-1"><strong>ğŸ–±ï¸ æ“ä½œ:</strong> ${escapeHtml(details.operation || 'N/A')}</div>
                                    <div class="mb-1"><strong>âŒ é—®é¢˜:</strong> ${escapeHtml(details.problem || 'N/A')}</div>
                                    <div class="mb-2"><strong>ğŸ” æ ¹å› åˆ†æ:</strong></div>
                                    <div class="root-cause-box" style="background: #fff3cd; border-radius: 4px; padding: 10px; margin-bottom: 8px; white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.5;">${rootCauseHtml}</div>
                                    ${jsErrorsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        return `
            <div class="card ${statusClass}">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <span class="step-icon">${statusIcon}</span>
                                <strong>æ­¥éª¤ ${step.number}: ${escapeHtml(step.name)}</strong>
                                ${durationHtml}
                            </div>
                            ${step.description ? `<div class="step-description">ğŸ“ ${escapeHtml(step.description)}</div>` : ''}
                            ${step.result ? `<div class="step-result">ğŸ’¡ ${escapeHtml(step.result)}</div>` : ''}
                            ${step.error ? `<div class="step-error">âš ï¸ ${escapeHtml(step.error)}</div>` : ''}
                            ${issueDetailsHtml}
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    stepsList.innerHTML = html;
}

// æ›´æ–°æµ‹è¯•æ—¥å¿—
let lastLogCount = 0;
function updateTestLogs(logs) {
    const logsDiv = document.getElementById('test-output-log');

    if (logs.length > lastLogCount) {
        const newLogs = logs.slice(lastLogCount);
        const logsHtml = newLogs.map(log => {
            if (log.includes('ERROR') || log.includes('å¤±è´¥') || log.includes('âœ—')) {
                return `<div class="log-error">${escapeHtml(log)}</div>`;
            } else if (log.includes('SUCCESS') || log.includes('æˆåŠŸ') || log.includes('âœ“')) {
                return `<div class="log-success">${escapeHtml(log)}</div>`;
            } else if (log.includes('WARNING') || log.includes('è­¦å‘Š')) {
                return `<div class="log-warning">${escapeHtml(log)}</div>`;
            }
            return `<div>${escapeHtml(log)}</div>`;
        }).join('');

        if (lastLogCount === 0) {
            logsDiv.innerHTML = logsHtml;
        } else {
            logsDiv.insertAdjacentHTML('beforeend', logsHtml);
        }

        logsDiv.scrollTop = logsDiv.scrollHeight;
        lastLogCount = logs.length;
    }
}

// åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º
function toggleTestLogs() {
    const logsDiv = document.getElementById('test-output-log');
    const btn = document.getElementById('toggle-logs-btn');

    if (logsDiv.style.display === 'none') {
        logsDiv.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-chevron-up"></i> éšè—è¯¦ç»†æ—¥å¿—';
    } else {
        logsDiv.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-chevron-down"></i> æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—';
    }
}

// æµ‹è¯•å®Œæˆ
function onTestComplete(result) {
    hideTestExecutionCard();

    if (result.status === 'completed' || result.status === 'failed') {
        // ğŸ”§ ä¿®å¤: ç»Ÿè®¡å¤±è´¥æ­¥éª¤æ•°æ¥åˆ¤å®šæ˜¯å¦çœŸæ­£é€šè¿‡
        const steps = result.test_steps || [];
        const failedCount = steps.filter(s => s.status === 'failed').length;

        if (failedCount > 0) {
            utils.showToast('æµ‹è¯•æ‰§è¡Œå®Œæˆï¼Œå­˜åœ¨å¤±è´¥æ­¥éª¤ï¼', 'warning');
        } else {
            utils.showToast('æµ‹è¯•æ‰§è¡Œå®Œæˆï¼', 'success');
        }
        // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        showDetailedResults(result);
    } else {
        utils.showToast('æµ‹è¯•æ‰§è¡Œå¤±è´¥', 'error');
    }
}

// æ˜¾ç¤ºè¯¦ç»†æµ‹è¯•ç»“æœ
function showDetailedResults(result) {
    const resultsCard = document.getElementById('current-test-results');
    resultsCard.style.display = 'block';

    // ğŸ”§ ä¿®å¤: åˆå¹¶é¢„å®šä¹‰æ­¥éª¤ä¸åç«¯è¿”å›çš„æ­¥éª¤ï¼Œç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½æ˜¾ç¤º
    const predefinedSteps = currentTestMode === 'quick' ? QUICK_TEST_STEPS : FULL_TEST_STEPS;
    const backendSteps = result.test_steps || [];

    // åˆå¹¶æ­¥éª¤ï¼šä»¥é¢„å®šä¹‰æ­¥éª¤ä¸ºåŸºç¡€ï¼Œç”¨åç«¯è¿”å›çš„çŠ¶æ€æ›´æ–°
    const steps = predefinedSteps.map(predefined => {
        const backendStep = backendSteps.find(s => s.number === predefined.number);
        if (backendStep) {
            return {
                ...predefined,
                ...backendStep
            };
        }
        // å¦‚æœåç«¯æ²¡æœ‰è¿”å›è¯¥æ­¥éª¤çš„ç»“æœï¼Œæ ‡è®°ä¸ºpending
        return { ...predefined, status: 'pending' };
    });

    // è·å–æ­¥éª¤ç»Ÿè®¡
    const passedCount = steps.filter(s => s.status === 'passed').length;
    const failedCount = steps.filter(s => s.status === 'failed').length;
    const totalCount = steps.length;

    // æ›´æ–°å¡ç‰‡å¤´éƒ¨çŠ¶æ€
    const cardHeader = resultsCard.querySelector('.card-header');
    if (failedCount === 0 && passedCount === totalCount) {
        cardHeader.classList.remove('bg-danger');
        cardHeader.classList.add('bg-success');
        cardHeader.querySelector('span').innerHTML = '<i class="bi bi-check-circle"></i> æµ‹è¯•å®Œæˆ - å…¨éƒ¨é€šè¿‡';
    } else if (failedCount > 0) {
        cardHeader.classList.remove('bg-success');
        cardHeader.classList.add('bg-danger');
        cardHeader.querySelector('span').innerHTML = '<i class="bi bi-x-circle"></i> æµ‹è¯•å®Œæˆ - å­˜åœ¨å¤±è´¥';
    } else {
        cardHeader.classList.remove('bg-success', 'bg-danger');
        cardHeader.classList.add('bg-warning');
        cardHeader.querySelector('span').innerHTML = '<i class="bi bi-exclamation-circle"></i> æµ‹è¯•å®Œæˆ - éƒ¨åˆ†æ­¥éª¤æœªå®Œæˆ';
    }

    // æ›´æ–°æ€»ä½“ç»Ÿè®¡
    const allPassed = failedCount === 0 && passedCount === totalCount;
    document.getElementById('result-status-icon').textContent = allPassed ? 'âœ“' : 'âœ—';
    document.getElementById('result-status').textContent = allPassed ? 'PASSED' : 'FAILED';
    document.getElementById('result-status').className = allPassed ? 'mb-0 text-success' : 'mb-0 text-danger';

    document.getElementById('result-duration').textContent = (result.result?.duration || 0).toFixed(2) + 's';
    document.getElementById('result-passed').textContent = passedCount;
    document.getElementById('result-total').textContent = totalCount;
    document.getElementById('result-failed').textContent = failedCount;

    // æ˜¾ç¤ºè¯¦ç»†æ­¥éª¤
    const stepsContainer = document.getElementById('result-steps-container');
    if (steps.length > 0) {
        stepsContainer.innerHTML = '<h6 class="mb-3">è¯¦ç»†æ­¥éª¤</h6>' +
            steps.map(step => {
                let statusIcon = '';
                let statusClass = '';
                let statusBadge = '';

                if (step.status === 'passed') {
                    statusIcon = 'âœ“';
                    statusClass = 'border-success';
                    statusBadge = '<span class="badge bg-success">é€šè¿‡</span>';
                } else if (step.status === 'failed') {
                    statusIcon = 'âœ—';
                    statusClass = 'border-danger';
                    statusBadge = '<span class="badge bg-danger">å¤±è´¥</span>';
                } else if (step.status === 'skipped') {
                    statusIcon = 'âŠ˜';
                    statusClass = 'border-warning';
                    statusBadge = '<span class="badge bg-warning">è·³è¿‡</span>';
                }

                let durationHtml = '';
                if (step.duration !== undefined) {
                    durationHtml = `<span class="step-duration ms-2">â± ${step.duration}s</span>`;
                }

                // ç”Ÿæˆé—®é¢˜è¯¦æƒ…HTMLï¼ˆå¦‚æœå­˜åœ¨ï¼‰- ä½¿ç”¨ä¸updateTestStepsç›¸åŒçš„æ ¼å¼
                let issueDetailsHtml = '';
                if (step.issue_details) {
                    const details = step.issue_details;
                    const resultStepId = `result-issue-${step.number}`;
                    const naturalExplanation = generateNaturalExplanation(details);

                    const jsErrorsHtml = details.js_errors && details.js_errors.length > 0
                        ? `<div class="mt-2"><strong>JavaScripté”™è¯¯:</strong>
                             <ul class="mb-0 mt-1">
                               ${details.js_errors.slice(0, 3).map(err => `<li class="text-danger small">${escapeHtml(err)}</li>`).join('')}
                               ${details.js_errors.length > 3 ? `<li class="text-muted small">...è¿˜æœ‰ ${details.js_errors.length - 3} ä¸ªé”™è¯¯</li>` : ''}
                             </ul>
                           </div>`
                        : '';

                    // ğŸ”§ æ”¹è¿›: æ ¹å› åˆ†ææ”¯æŒæ¢è¡Œå’Œæ ¼å¼åŒ–æ˜¾ç¤º
                    const rootCauseHtml = formatRootCause(details.root_cause || 'N/A');

                    issueDetailsHtml = `
                        <div class="alert alert-danger mt-2 mb-0" style="background-color: #f8d7da; border-left: 4px solid #dc3545;">
                            <div class="d-flex align-items-start">
                                <span class="me-2">ğŸ›</span>
                                <div class="flex-grow-1">
                                    <strong>å‘ç°Bug:</strong> ${escapeHtml(naturalExplanation)}
                                    <div class="mt-2">
                                        <a class="text-decoration-none small" data-bs-toggle="collapse" href="#${resultStepId}" role="button" aria-expanded="false">
                                            <i class="bi bi-chevron-down"></i> æŸ¥çœ‹è¯¦ç»†æŠ€æœ¯ä¿¡æ¯ä¸ä¿®å¤å»ºè®®
                                        </a>
                                    </div>
                                    <div class="collapse mt-2" id="${resultStepId}">
                                        <div class="card card-body bg-light small py-2">
                                            <div class="mb-1"><strong>ğŸ“ åœºæ™¯:</strong> ${escapeHtml(details.scenario || 'N/A')}</div>
                                            <div class="mb-1"><strong>ğŸ–±ï¸ æ“ä½œ:</strong> ${escapeHtml(details.operation || 'N/A')}</div>
                                            <div class="mb-1"><strong>âŒ é—®é¢˜:</strong> ${escapeHtml(details.problem || 'N/A')}</div>
                                            <div class="mb-2"><strong>ğŸ” æ ¹å› åˆ†æ:</strong></div>
                                            <div class="root-cause-box" style="background: #fff3cd; border-radius: 4px; padding: 10px; margin-bottom: 8px; white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; line-height: 1.5;">${rootCauseHtml}</div>
                                            ${jsErrorsHtml}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="card ${statusClass} mb-2">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center">
                                        <span class="step-icon">${statusIcon}</span>
                                        <strong>æ­¥éª¤ ${step.number}: ${escapeHtml(step.name)}</strong>
                                        ${durationHtml}
                                    </div>
                                    ${step.description ? `<div class="step-description">ğŸ“ ${escapeHtml(step.description)}</div>` : ''}
                                    ${step.result ? `<div class="step-result">ğŸ’¡ ${escapeHtml(step.result)}</div>` : ''}
                                    ${step.error ? `<div class="step-error">âš ï¸ ${escapeHtml(step.error)}</div>` : ''}
                                    ${issueDetailsHtml}
                                </div>
                                <div>
                                    ${statusBadge}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
    } else {
        stepsContainer.innerHTML = '<p class="text-muted">æ— æ­¥éª¤ä¿¡æ¯</p>';
    }

    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// æ¸…é™¤å½“å‰ç»“æœ
function clearCurrentResults() {
    document.getElementById('current-test-results').style.display = 'none';
}

// æ›´æ–°å·²ç”¨æ—¶é—´
function updateElapsedTime() {
    if (!testStartTime) return;

    const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;

    document.getElementById('test-elapsed-time').textContent =
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// å·¥å…·å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ğŸ”§ æ ¼å¼åŒ–æ ¹å› åˆ†æå†…å®¹ï¼Œæ”¯æŒæ¢è¡Œå’Œç‰¹æ®Šæ ‡è®°
function formatRootCause(rootCause) {
    if (!rootCause) return 'N/A';

    // å…ˆè½¬ä¹‰HTML
    let html = escapeHtml(rootCause);

    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
    html = html.replace(/\n/g, '<br>');

    // é«˜äº®ã€xxxã€‘æ ‡è®°
    html = html.replace(/ã€([^ã€‘]+)ã€‘/g, '<strong style="color: #d63384;">ã€$1ã€‘</strong>');

    // é«˜äº® â€¢ åˆ—è¡¨é¡¹
    html = html.replace(/â€¢/g, '<span style="color: #0d6efd;">â€¢</span>');

    return html;
}

// ğŸ”§ ç”Ÿæˆè‡ªç„¶è¯­è¨€çš„é—®é¢˜è§£é‡Šï¼ˆåŒ…å«å…·ä½“çš„ç½‘é¡µã€æ“ä½œã€é—®é¢˜æè¿°ï¼‰
function generateNaturalExplanation(details) {
    if (!details) return 'æœªçŸ¥é—®é¢˜';

    const scenario = details.scenario || '';
    const operation = details.operation || '';
    const problem = details.problem || '';
    const root_cause = details.root_cause || '';

    // æ„å»ºå…·ä½“çš„æè¿°
    let explanation = '';

    // 1. åœ¨å“ªä¸ªç½‘é¡µ
    let pageInfo = '';
    if (scenario.includes('è´­ç‰©è½¦')) {
        pageInfo = 'åœ¨è´­ç‰©è½¦é¡µé¢ï¼ˆfiido.com/cartï¼‰';
    } else if (scenario.includes('å•†å“')) {
        pageInfo = 'åœ¨å•†å“è¯¦æƒ…é¡µ';
    } else if (scenario.includes('æ”¯ä»˜') || scenario.includes('Checkout')) {
        pageInfo = 'åœ¨æ”¯ä»˜æµç¨‹ä¸­';
    }

    // 2. æ‰§è¡Œä»€ä¹ˆæ“ä½œ
    let actionInfo = '';
    if (operation.includes('åŠ å·') || operation.includes('å¢åŠ ')) {
        actionInfo = 'ç‚¹å‡»å•†å“æ•°é‡"+"æŒ‰é’®';
    } else if (operation.includes('å‡å·') || operation.includes('å‡å°‘')) {
        actionInfo = 'ç‚¹å‡»å•†å“æ•°é‡"-"æŒ‰é’®';
    } else if (operation.includes('Checkout') || operation.includes('æ”¯ä»˜')) {
        actionInfo = 'ç‚¹å‡»ç»“è´¦æŒ‰é’®';
    } else if (operation) {
        actionInfo = operation;
    }

    // 3. å‡ºç°ä»€ä¹ˆé—®é¢˜
    let problemInfo = '';
    if (problem.includes('æ•°é‡æœªå‘ç”Ÿå˜åŒ–')) {
        problemInfo = 'å•†å“æ•°é‡æ²¡æœ‰å˜åŒ–ï¼ŒæŒ‰é’®ç‚¹å‡»æ— æ•ˆ';
    } else if (problem.includes('JavaScripté”™è¯¯')) {
        problemInfo = 'é¡µé¢å‡ºç°JavaScripté”™è¯¯';
    } else if (problem) {
        problemInfo = problem;
    }

    // ç»„åˆæˆå®Œæ•´çš„æè¿°
    if (pageInfo && actionInfo && problemInfo) {
        explanation = `${pageInfo}ï¼Œç”¨æˆ·${actionInfo}æ—¶ï¼Œ${problemInfo}ã€‚`;
    } else if (scenario && problem) {
        explanation = `${scenario}æ—¶ï¼Œ${problem}ã€‚`;
    } else if (problem) {
        explanation = problem;
    } else {
        explanation = 'æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°å¼‚å¸¸ã€‚';
    }

    // æ·»åŠ å½±å“è¯´æ˜
    if (root_cause.includes('è´­ç‰©è½¦') || scenario.includes('è´­ç‰©è½¦')) {
        explanation += ' è¿™ä¼šå½±å“ç”¨æˆ·ä¿®æ”¹è´­ä¹°æ•°é‡çš„æ“ä½œã€‚';
    } else if (root_cause.includes('Checkout') || scenario.includes('æ”¯ä»˜')) {
        explanation += ' è¿™æ˜¯é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´ç”¨æˆ·æ— æ³•å®Œæˆè´­ä¹°ã€‚';
    }

    return explanation;
}
</script>
{% endblock %}
