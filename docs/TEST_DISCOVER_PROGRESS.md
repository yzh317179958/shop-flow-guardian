# 商品发现实时进度显示 - 测试验收指南

## 本次修改内容

### 修改目标
在Web端点击"发现商品"后，能够实时显示发现过程和统计结果，以自然语言方式展现。

### 修改文件
1. `web/app.py` - 改进 `run_command()` 函数，支持实时输出捕获和进度解析
2. `web/templates/products.html` - 添加实时进度对话框和统计显示
3. `web/templates/index.html` - 更新首页的商品发现功能

### 新增功能
- ✅ 实时捕获命令输出
- ✅ 解析进度信息（当前分类/总分类）
- ✅ 显示处理日志（可展开/收起）
- ✅ 显示最终统计（扫描分类数、商品总数、新增商品、执行耗时）
- ✅ 进度条实时更新
- ✅ 自然语言状态消息

---

## 手动测试步骤

### 测试环境准备

1. **启动Web服务**
   ```bash
   # 停止旧的Web服务（如果正在运行）
   pkill -f "python.*web/app.py"

   # 启动新的Web服务
   cd /home/yzh/fiido-shop-flow-guardian
   python3 web/app.py
   ```

2. **打开浏览器**
   访问：http://localhost:5000

---

### 测试1: 商品管理页面 - 商品发现

**目的**: 验证商品管理页面的实时进度显示

**步骤**:

1. 浏览器访问：http://localhost:5000/products

2. 点击页面右上角的 **"发现商品"** 按钮

3. 在弹出的确认对话框中，点击 **"确定"**

4. 观察弹出的进度对话框

**预期结果**:

✅ **进度对话框应该包含以下元素**:
- 标题："正在发现商品"
- 进度条（蓝色，带动画）
- 进度百分比（0% → 100%）
- 当前状态消息（自然语言）
- "处理日志"展开按钮
- 统计信息卡片（完成后显示）
- "关闭"按钮（初始禁用）

✅ **实时进度更新**:
- 状态消息实时变化，例如：
  - "正在初始化..."
  - "正在发现所有商品分类..."
  - "发现了 35 个商品分类"
  - "正在处理分类 1/35: /collections/accessories"
  - "在 /collections/accessories 中发现 10 个商品"
  - 等等...

✅ **进度条更新**:
- 进度条从 0% 逐渐增加到 100%
- 进度百分比数字同步更新
- 进度条有平滑动画效果

✅ **日志显示**（点击"展开"后）:
- 显示实时日志输出
- 日志自动滚动到最新内容
- 关键信息高亮显示：
  - 错误信息：红色
  - 成功信息（Found/Discovered）：绿色
  - 警告信息：黄色

✅ **统计信息**（完成后显示）:
- 扫描分类数：显示具体数字（例如：51）
- 商品总数：显示具体数字（例如：505）
- 新增商品：显示具体数字（例如：505）
- 执行耗时：显示具体时间（例如：38.40s）

✅ **完成状态**:
- 进度条变为 100%，停止动画
- 状态消息变为："商品发现完成！"（带绿色勾图标）
- "关闭"按钮变为可用
- 显示成功提示Toast

✅ **关闭后**:
- 点击"关闭"按钮
- 对话框消失
- 页面自动刷新
- 商品列表显示新发现的商品

---

### 测试2: 首页 - 快速商品发现

**目的**: 验证首页的商品发现功能

**步骤**:

1. 浏览器访问：http://localhost:5000

2. 在"快速操作"区域，点击 **"发现商品"** 按钮

3. 观察任务执行模态框

**预期结果**:

✅ **任务执行模态框显示**:
- 标题："任务执行中"
- 进度条（带动画）
- 状态消息实时更新
  - "正在发现所有商品分类..."
  - "发现了 X 个商品分类"
  - "正在处理分类 X/Y: ..."
  - "商品发现完成！"

✅ **完成后显示统计Toast**:
- 包含以下信息：
  - "商品发现完成！"
  - "扫描分类数: X"
  - "商品总数: X"
  - "新增商品: X"

✅ **页面自动刷新**:
- Toast显示1秒后
- 页面自动刷新
- 概览页数据更新

---

### 测试3: 中断和错误处理

**目的**: 验证异常情况的处理

**测试3.1: 网络中断模拟**

**步骤**:
1. 点击"发现商品"
2. 等待任务开始执行
3. 在浏览器开发者工具中切换到"Network"标签
4. 勾选"Offline"模拟网络中断

**预期结果**:
- ✅ 显示错误提示："无法获取任务状态"
- ✅ 不会导致页面崩溃

**测试3.2: 快速关闭页面**

**步骤**:
1. 点击"发现商品"
2. 任务开始后，立即刷新页面

**预期结果**:
- ✅ 任务继续在后台执行
- ✅ 刷新后可以重新访问商品页面
- ✅ 商品发现完成后，数据文件正常更新

---

### 测试4: 数据验证

**目的**: 验证统计数据的准确性

**步骤**:

1. 完成商品发现后，查看对话框中的统计数据

2. 在终端手动运行相同命令，对比结果：
   ```bash
   ./run.sh python3 scripts/discover_products.py
   ```

3. 对比两者的统计数据

**预期结果**:

✅ **数据一致性**:
- Web端显示的"扫描分类数"= 终端显示的"扫描分类数"
- Web端显示的"商品总数" = 终端显示的"商品总数"
- Web端显示的"新增商品" = 终端显示的"新增商品"
- 执行耗时相差不超过1秒

---

## 验收标准

### 必须满足（P0）

- [ ] 进度对话框正常弹出和关闭
- [ ] 进度条能从0%更新到100%
- [ ] 状态消息实时更新且为自然语言
- [ ] 统计数据完整显示（4项）
- [ ] 统计数据准确（与命令行一致）
- [ ] 完成后能正常关闭并刷新页面

### 应该满足（P1）

- [ ] 日志实时显示且可展开/收起
- [ ] 日志关键信息高亮显示
- [ ] 日志自动滚动到最新内容
- [ ] 错误情况有友好提示

### 可以满足（P2）

- [ ] 进度条动画流畅
- [ ] Toast通知样式美观
- [ ] 整体用户体验良好

---

## 已知问题

### 问题1: Windows系统兼容性

**描述**: `select` 模块在Windows上可能不可用

**影响**: Windows用户可能无法使用实时进度功能

**解决方案**: 代码已处理此问题，Windows下会退回到原有逻辑

### 问题2: 日志中文乱码

**描述**: 某些环境下中文可能显示乱码

**影响**: 日志可读性下降

**临时方案**: 确保系统locale设置为UTF-8

---

## 回滚方案

如果测试失败，执行以下步骤回滚：

```bash
cd /home/yzh/fiido-shop-flow-guardian

# 回滚修改的文件
git checkout web/app.py
git checkout web/templates/products.html
git checkout web/templates/index.html

# 重启Web服务
pkill -f "python.*web/app.py"
python3 web/app.py
```

---

## 测试记录

| 测试项 | 测试时间 | 测试结果 | 备注 |
|--------|----------|----------|------|
| 商品管理页面进度显示 | ________ | ⬜ 通过 / ⬜ 失败 | ____ |
| 首页快速商品发现 | ________ | ⬜ 通过 / ⬜ 失败 | ____ |
| 错误处理 | ________ | ⬜ 通过 / ⬜ 失败 | ____ |
| 数据准确性 | ________ | ⬜ 通过 / ⬜ 失败 | ____ |

---

## 截图示例

建议截图以下场景以便验收：

1. 进度对话框 - 执行中（进度50%）
2. 进度对话框 - 展开日志
3. 进度对话框 - 完成状态（显示统计）
4. 首页 - 统计Toast显示

---

**版本**: v1.0
**更新日期**: 2025-12-04
**测试人**: _________
**验收人**: _________
